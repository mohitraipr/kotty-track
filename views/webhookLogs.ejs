<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventory Webhook Logs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/professional.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Inventory Webhook Logs</span>
    <span class="text-white ms-auto">Showing last <%= logs.length %> entries (from database)</span>
  </div>
</nav>
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Inventory Snapshots</h3>
    <div class="d-flex gap-2 align-items-center">
      <div id="clearStatus" class="d-none">
        <div class="d-flex align-items-center gap-2">
          <div class="progress" style="width: 200px; height: 20px;">
            <div id="clearProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
          </div>
          <small id="clearText" class="text-muted"></small>
        </div>
      </div>
      <button id="clearBtn" class="btn btn-outline-danger btn-sm" onclick="clearRawData()">Clear Raw Data</button>
      <a href="/webhook/order/logs" class="btn btn-outline-primary btn-sm">View Order Logs</a>
    </div>
  </div>
  <div class="table-responsive shadow-sm">
    <table class="table table-bordered table-striped table-hover table-sm align-middle">
      <thead class="table-dark">
        <tr>
          <th>Time</th>
          <th>SKU</th>
          <th>Warehouse</th>
          <th>Inventory</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
      <% logs.forEach(function(log) { %>
        <tr>
          <td><%= log.time %></td>
          <td><strong><%= log.sku %></strong></td>
          <td><%= log.warehouse_id || 'N/A' %></td>
          <td><%= log.inventory != null ? log.inventory : 'N/A' %></td>
          <td><%= log.sku_status || 'N/A' %></td>
        </tr>
      <% }); %>
      <% if (!logs.length) { %>
        <tr><td colspan="5" class="text-center text-muted">No inventory snapshots found</td></tr>
      <% } %>
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function clearRawData() {
  const btn = document.getElementById('clearBtn');
  const status = document.getElementById('clearStatus');
  const progress = document.getElementById('clearProgress');
  const text = document.getElementById('clearText');

  btn.disabled = true;
  btn.textContent = 'Checking...';
  try {
    const countRes = await fetch('/webhook/clear-raw/inventory/count');
    const countData = await countRes.json();
    if (countData.total === 0) {
      btn.textContent = 'Already clean';
      btn.classList.replace('btn-outline-danger', 'btn-outline-success');
      return;
    }
    if (!confirm('Clear raw JSON data from ' + countData.total.toLocaleString() + ' inventory snapshots? This frees disk space but cannot be undone.')) {
      btn.disabled = false;
      btn.textContent = 'Clear Raw Data';
      return;
    }
    status.classList.remove('d-none');
    btn.classList.add('d-none');

    let totalCleared = 0;
    const originalTotal = countData.total;

    // Auto-retry loop until done
    while (true) {
      const pct = Math.min(95, Math.round((totalCleared / originalTotal) * 100));
      progress.style.width = pct + '%';
      progress.textContent = pct + '%';
      text.textContent = 'Cleared ' + totalCleared.toLocaleString() + ' / ' + originalTotal.toLocaleString() + '...';

      const res = await fetch('/webhook/clear-raw/inventory', { method: 'POST' });
      const data = await res.json();
      totalCleared += data.cleared;

      if (data.done) {
        progress.style.width = '100%';
        progress.classList.remove('progress-bar-animated');
        progress.classList.replace('bg-primary', 'bg-success');
        progress.textContent = 'Done!';
        text.textContent = 'Cleared ' + totalCleared.toLocaleString() + ' rows';
        btn.classList.remove('d-none');
        btn.textContent = 'Cleared!';
        btn.classList.replace('btn-outline-danger', 'btn-outline-success');
        break;
      }
    }
  } catch (err) {
    progress.style.width = '100%';
    progress.classList.add('bg-danger');
    progress.textContent = 'Error';
    text.textContent = err.message;
    btn.classList.remove('d-none');
    btn.disabled = false;
    btn.textContent = 'Retry';
  }
}
</script>
</body>
</html>
