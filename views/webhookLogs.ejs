<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webhook Logs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Webhook Logs</span>
  </div>
</nav>
<div class="container py-4">
  <h3 class="mb-4">Inventory Webhook Calls</h3>
  <div class="table-responsive shadow-sm">
    <table id="log-table" class="table table-bordered table-striped table-sm align-middle">
      <thead class="table-dark">
        <tr>
          <th>Time</th>
          <th>Access Token</th>
          <th>Raw Body</th>
          <th>Parsed Data</th>
        </tr>
      </thead>
      <tbody id="log-body">
      <% logs.slice().reverse().forEach(function(log) { %>
        <tr>
          <td><%= log.time %></td>
          <td><%= log.accessToken %></td>
          <td><pre class="mb-0"><%= log.raw %></pre></td>
          <td><pre class="mb-0"><%= JSON.stringify(log.data, null, 2) %></pre></td>
        </tr>
      <% }); %>
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const logBody = document.getElementById('log-body');
  const evtSource = new EventSource('/webhook/logs/stream');

  evtSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.logs) {
      data.logs.slice().reverse().forEach(addRow);
    } else if (data.log) {
      addRow(data.log);
    } else if (data.alert) {
      showNotification(data.alert.message);
    }
  };

  function addRow(log) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${log.time}</td>
      <td>${log.accessToken || ''}</td>
      <td><pre class="mb-0">${log.raw}</pre></td>
      <td><pre class="mb-0">${JSON.stringify(log.data, null, 2)}</pre></td>
    `;
    logBody.prepend(row);
    if (logBody.rows.length > 50) {
      logBody.deleteRow(-1);
    }
  }

  function showNotification(msg) {
    if (window.Notification && Notification.permission === 'granted') {
      new Notification('Inventory Alert', { body: msg });
    }
  }

  if (window.Notification && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }
</script>
</body>
</html>
