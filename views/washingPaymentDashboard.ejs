<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Washing Payments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Washing Payments</span>
    <div class="d-flex gap-2 ms-auto">
      <a href="/washingdashboard/payments/invoices" class="btn btn-outline-light btn-sm">Invoices</a>
      <a href="/operator" class="btn btn-outline-light btn-sm">Back</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="input-group mb-3">
    <input type="text" class="form-control" placeholder="Search washer..." id="searchWasher">
    <button class="btn btn-outline-secondary" type="button" id="searchBtn" data-bs-toggle="tooltip" title="Search washers">
      <i class="fa fa-search"></i>
    </button>
  </div>

  <div class="row" id="washerList">
    <% washers.forEach(function(w){ %>
      <div class="col-md-4 mb-3 washer-card" data-washer-name="<%= w.username.toLowerCase() %>" data-washer-id="<%= w.id %>">
        <div class="card h-100 shadow-sm">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <i class="fa fa-user me-2 text-primary" data-bs-toggle="tooltip" title="Washer"></i>
              <span class="washer-name"><%= w.username %></span>
              <span class="badge bg-secondary" id="count-<%= w.id %>"><%= w.lot_count %> lots</span>
            </div>
            <button
              class="btn btn-sm btn-outline-primary collapse-btn"
              data-bs-toggle="collapse"
              data-bs-target="#lots-<%= w.id %>"
              aria-expanded="false"
              aria-controls="lots-<%= w.id %>"
              title="View lots">
              <i class="fa fa-eye"></i>
            </button>
          </div>
          <div id="lots-<%= w.id %>" class="collapse" data-loaded="false">
            <div class="card-body">
              <div class="text-center text-muted">Select to view lots</div>
            </div>
          </div>
        </div>
      </div>
    <% }); %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function filterWashers() {
    const q = document.getElementById('searchWasher').value.toLowerCase();
    document.querySelectorAll('.washer-card').forEach(card => {
      const name = card.dataset.washerName;
      card.style.display = name.includes(q) ? '' : 'none';
    });
  }
  document.getElementById('searchBtn').addEventListener('click', filterWashers);
  document.getElementById('searchWasher').addEventListener('keydown', function(e){
    if (e.key === 'Enter') {
      e.preventDefault();
      filterWashers();
    }
  });

  // enable tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], .collapse-btn'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

  // load lots on first expansion
  document.querySelectorAll('.collapse').forEach(col => {
    col.addEventListener('show.bs.collapse', async function () {
      if (this.dataset.loaded === 'true') return;
      const washerId = this.id.split('-')[1];
      const body = this.querySelector('.card-body');
      body.innerHTML = '<div class="text-center text-muted">Loading...</div>';
      try {
        const res = await fetch(`/washingdashboard/payments/washer/${washerId}/lots`);
        const data = await res.json();
        if (!data.lots.length) {
          body.innerHTML = '<p class="text-muted">No pending lots.</p>';
          this.dataset.loaded = 'true';
          return;
        }
        const form = document.createElement('form');
        form.className = 'lotForm';
        let tableHtml = '<table class="table table-sm table-bordered"><thead><tr><th>Lot</th><th>Qty</th><th>Select</th></tr></thead><tbody>';
        data.lots.forEach(l => {
          tableHtml += `<tr><td>${l.lot_no}</td><td>${l.total_pieces}</td><td><input type="checkbox" name="lotIds" value="${l.id}"></td></tr>`;
        });
        tableHtml += '</tbody></table><div class="text-end"><button type="button" class="btn btn-success proceedBtn"><i class="fa fa-arrow-right"></i> Proceed to Payment</button></div>';
        form.innerHTML = tableHtml;
        body.innerHTML = '';
        body.appendChild(form);
        form.querySelector('.proceedBtn').addEventListener('click', function(){
          const ids = Array.from(form.querySelectorAll('input[name="lotIds"]:checked')).map(c=>c.value);
          if(!ids.length) return;
          window.location.href = '/washingdashboard/payments/summary?ids=' + ids.join(',');
        });
        this.dataset.loaded = 'true';
      } catch (err) {
        body.innerHTML = '<p class="text-danger">Failed to load lots</p>';
      }
    });
  });
</script>
</body>
</html>

