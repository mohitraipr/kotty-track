<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cash Flow - Pending Refunds - Kotty Track</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f8f9fa;
      padding-top: 70px;
    }

    .top-nav {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 16px 24px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-brand {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
      text-decoration: none;
    }

    .container-main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: #1e293b;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }

    .summary-card.primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
    }

    .summary-value {
      font-size: 36px;
      font-weight: 700;
    }

    .summary-label {
      font-size: 13px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
    }

    .refund-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .refund-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s;
    }

    .refund-item:hover {
      background: #f8fafc;
    }

    .refund-item:last-child {
      border-bottom: none;
    }

    .refund-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .refund-avatar {
      width: 48px;
      height: 48px;
      background: #eff6ff;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #2563eb;
    }

    .refund-details h4 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      color: #1e293b;
    }

    .refund-details p {
      margin: 0;
      font-size: 13px;
      color: #64748b;
    }

    .refund-amount {
      text-align: right;
    }

    .refund-amount .amount {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
    }

    .refund-amount .method {
      font-size: 12px;
      color: #64748b;
    }

    .bank-details {
      background: #f8fafc;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      font-size: 13px;
    }

    .bank-details .label {
      color: #64748b;
    }

    .bank-details .value {
      color: #1e293b;
      font-weight: 500;
    }

    .badge-waiting {
      background: #fef3c7;
      color: #92400e;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-ready {
      background: #dcfce7;
      color: #166534;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }

    .action-btn-success {
      background: #22c55e;
      color: white;
    }

    .action-btn-success:hover {
      background: #16a34a;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <a href="/operator/dashboard" class="nav-brand">
      <i class="bi bi-box-seam me-2"></i>Kotty Track
    </a>
    <div>
      <a href="/returns/dashboard" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Back to Returns
      </a>
    </div>
  </nav>

  <div class="container-main">
    <div class="page-header">
      <div>
        <h1 class="page-title">Cash Flow - Pending Refunds</h1>
        <p class="text-muted">Track and process pending customer refunds</p>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card primary">
        <div class="summary-value"><%= formatCurrency(totalPending) %></div>
        <div class="summary-label">Total Pending</div>
      </div>
      <div class="summary-card">
        <div class="summary-value"><%= pendingRefunds.length %></div>
        <div class="summary-label">Pending Refunds</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" style="color: #22c55e;"><%= withBankDetails %></div>
        <div class="summary-label">Ready to Pay</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" style="color: #f59e0b;"><%= withoutBankDetails %></div>
        <div class="summary-label">Awaiting Bank Details</div>
      </div>
    </div>

    <!-- Ready to Pay -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-check-circle text-success me-2"></i>
        Ready to Pay (<%= withBankDetails %>)
      </div>
      <% const readyToPay = pendingRefunds.filter(r => r.bank_submitted_at); %>
      <% if (readyToPay.length === 0) { %>
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <p>No refunds ready to pay</p>
        </div>
      <% } else { %>
        <ul class="refund-list">
          <% readyToPay.forEach(refund => { %>
          <li class="refund-item">
            <div class="refund-info">
              <div class="refund-avatar">
                <%= (refund.customer_name || 'C').charAt(0).toUpperCase() %>
              </div>
              <div class="refund-details">
                <h4><%= refund.customer_name || 'Customer' %></h4>
                <p><%= refund.return_id %> | <%= refund.customer_phone || '-' %></p>
                <% if (refund.upi_id) { %>
                <div class="bank-details">
                  <span class="label">UPI:</span>
                  <span class="value"><%= refund.upi_id %></span>
                </div>
                <% } else if (refund.account_number) { %>
                <div class="bank-details">
                  <span class="label">Bank:</span>
                  <span class="value"><%= refund.bank_name %> | A/C: <%= maskAccountNumber(refund.account_number) %></span>
                </div>
                <% } %>
              </div>
            </div>
            <div class="refund-amount">
              <div class="amount"><%= formatCurrency(refund.refund_amount) %></div>
              <div class="method"><%= refund.order_type === 'cod' ? 'UPI/Bank' : 'Shopify' %></div>
              <a href="/returns/<%= refund.id %>?action=refund" class="action-btn action-btn-success mt-2">
                Process Refund
              </a>
            </div>
          </li>
          <% }) %>
        </ul>
      <% } %>
    </div>

    <!-- Awaiting Bank Details -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-hourglass-split text-warning me-2"></i>
        Awaiting Bank Details (<%= withoutBankDetails %>)
      </div>
      <% const awaitingDetails = pendingRefunds.filter(r => !r.bank_submitted_at && r.order_type === 'cod'); %>
      <% if (awaitingDetails.length === 0) { %>
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <p>No refunds awaiting bank details</p>
        </div>
      <% } else { %>
        <ul class="refund-list">
          <% awaitingDetails.forEach(refund => { %>
          <li class="refund-item">
            <div class="refund-info">
              <div class="refund-avatar" style="background: #fef3c7; color: #92400e;">
                <%= (refund.customer_name || 'C').charAt(0).toUpperCase() %>
              </div>
              <div class="refund-details">
                <h4><%= refund.customer_name || 'Customer' %></h4>
                <p><%= refund.return_id %> | <%= refund.customer_phone || '-' %></p>
                <span class="badge-waiting">Waiting for bank details</span>
              </div>
            </div>
            <div class="refund-amount">
              <div class="amount"><%= formatCurrency(refund.refund_amount) %></div>
              <button class="action-btn" style="background: #f59e0b; color: white; margin-top: 8px;" onclick="sendBankLink(<%= refund.id %>)">
                Send Link
              </button>
            </div>
          </li>
          <% }) %>
        </ul>
      <% } %>
    </div>

    <!-- Prepaid Refunds (if any) -->
    <% const prepaidRefunds = pendingRefunds.filter(r => r.order_type === 'prepaid'); %>
    <% if (prepaidRefunds.length > 0) { %>
    <div class="card">
      <div class="card-header">
        <i class="bi bi-credit-card text-primary me-2"></i>
        Prepaid Refunds (<%= prepaidRefunds.length %>)
      </div>
      <ul class="refund-list">
        <% prepaidRefunds.forEach(refund => { %>
        <li class="refund-item">
          <div class="refund-info">
            <div class="refund-avatar" style="background: #dcfce7; color: #166534;">
              <%= (refund.customer_name || 'C').charAt(0).toUpperCase() %>
            </div>
            <div class="refund-details">
              <h4><%= refund.customer_name || 'Customer' %></h4>
              <p><%= refund.return_id %> | Order: <%= refund.shopify_order_name %></p>
              <span class="badge-ready">Prepaid - Refund via Shopify</span>
            </div>
          </div>
          <div class="refund-amount">
            <div class="amount"><%= formatCurrency(refund.refund_amount) %></div>
            <a href="/returns/<%= refund.id %>?action=refund" class="action-btn action-btn-success mt-2">
              Process Shopify Refund
            </a>
          </div>
        </li>
        <% }) %>
      </ul>
    </div>
    <% } %>
  </div>

  <script>
    async function sendBankLink(id) {
      const res = await fetch(`/returns/${id}/send-bank-link`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        alert(`Bank link generated!\n\n${data.link}\n\nSend to: ${data.phone}`);
        navigator.clipboard.writeText(data.link);
      } else {
        alert(data.message || 'Failed');
      }
    }
  </script>
</body>
</html>
