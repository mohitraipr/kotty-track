<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Request a Return - Kotty</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .return-container {
      max-width: 640px;
      margin: 0 auto;
    }

    .brand-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .brand-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .brand-header p {
      color: #64748b;
      font-size: 15px;
    }

    .card {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .card-body {
      padding: 32px;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e2e8f0;
      transition: all 0.3s;
    }

    .step-dot.active {
      background: #2563eb;
      width: 32px;
      border-radius: 5px;
    }

    .step-dot.completed {
      background: #22c55e;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    .step-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .step-desc {
      color: #64748b;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .form-label {
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-control {
      border-radius: 10px;
      padding: 14px 16px;
      border: 1px solid #e2e8f0;
      font-size: 15px;
    }

    .form-control:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn-primary {
      background: #2563eb;
      border: none;
      border-radius: 10px;
      padding: 14px 28px;
      font-weight: 600;
      font-size: 15px;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-outline-secondary {
      border-radius: 10px;
      padding: 14px 28px;
      font-weight: 500;
    }

    .order-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .order-card:hover {
      border-color: #94a3b8;
    }

    .order-card.selected {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .order-card.ineligible {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .order-number {
      font-weight: 600;
      color: #1e293b;
    }

    .order-date {
      font-size: 13px;
      color: #64748b;
    }

    .order-summary {
      font-size: 14px;
      color: #64748b;
    }

    .order-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-eligible {
      background: #dcfce7;
      color: #166534;
    }

    .status-ineligible {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-can-issue {
      background: #fef3c7;
      color: #92400e;
    }

    .status-in-transit {
      background: #dbeafe;
      color: #1e40af;
    }

    .btn-raise-issue {
      background: #f59e0b;
      border: none;
      color: white;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      margin-top: 8px;
    }

    .btn-raise-issue:hover {
      background: #d97706;
      color: white;
    }

    .item-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .item-checkbox {
      width: 22px;
      height: 22px;
      accent-color: #2563eb;
    }

    .item-image {
      width: 60px;
      height: 60px;
      background: #f1f5f9;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #94a3b8;
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: 500;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .item-variant {
      font-size: 13px;
      color: #64748b;
    }

    .item-price {
      font-weight: 600;
      color: #1e293b;
    }

    .alert-info-custom {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 14px;
    }

    .alert-warning-custom {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      color: #92400e;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 14px;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #dcfce7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .success-icon i {
      font-size: 40px;
      color: #22c55e;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-orders {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .no-orders i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="return-container">
    <div class="brand-header">
      <h1>Request a Return</h1>
      <p>We're here to help with your return request</p>
    </div>

    <div class="card">
      <div class="card-body">
        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step-dot active" id="dot1"></div>
          <div class="step-dot" id="dot2"></div>
          <div class="step-dot" id="dot3"></div>
          <div class="step-dot" id="dot4"></div>
        </div>

        <!-- Step 1: Find Order -->
        <div class="step-content active" id="step1">
          <h2 class="step-title">Find Your Order</h2>
          <p class="step-desc">Enter your email or phone number to look up your orders</p>

          <form id="lookupForm">
            <div class="mb-4">
              <label class="form-label">Email or Phone Number</label>
              <input type="text" class="form-control" id="identifier"
                     placeholder="e.g., your@email.com or 9876543210" required>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="lookupBtn">
              Find My Orders
            </button>
          </form>

          <div id="lookupError" class="alert-warning-custom mt-3" style="display: none;"></div>
        </div>

        <!-- Step 2: Select Order -->
        <div class="step-content" id="step2">
          <h2 class="step-title">Select Your Order</h2>
          <p class="step-desc">Choose the order you want to return</p>

          <div id="ordersContainer"></div>

          <div class="d-flex gap-2 mt-4">
            <button class="btn btn-outline-secondary flex-fill" onclick="goToStep(1)">
              <i class="bi bi-arrow-left me-1"></i> Back
            </button>
            <button class="btn btn-primary flex-fill" id="selectOrderBtn" disabled onclick="goToStep(3)">
              Continue <i class="bi bi-arrow-right ms-1"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Select Items & Reason -->
        <div class="step-content" id="step3">
          <h2 class="step-title" id="step3Title">Select Items to Return</h2>
          <p class="step-desc" id="step3Desc">Choose which items you want to return and tell us why</p>

          <div id="itemsContainer" class="mb-4"></div>

          <div class="mb-4">
            <label class="form-label">Reason for Return</label>
            <select class="form-select form-control" id="returnReason" required>
              <option value="">Select a reason</option>
              <option value="size_issue">Size doesn't fit</option>
              <option value="quality_issue">Quality issue / Defect</option>
              <option value="wrong_product">Received wrong product</option>
              <option value="not_as_described">Product not as described</option>
              <option value="damaged_in_transit">Damaged during delivery</option>
              <option value="changed_mind">Changed my mind</option>
              <option value="missing_items">Missing items in order</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label">Additional Details (Optional)</label>
            <textarea class="form-control" id="notes" rows="3"
                      placeholder="Please provide any additional details about your return..."></textarea>
          </div>

          <!-- Bank Details Section (for COD orders) -->
          <div id="bankDetailsSection" class="mb-4" style="display: none;">
            <div class="alert-warning-custom mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <strong>COD Order:</strong> Please provide your bank details for refund.
            </div>

            <label class="form-label">Refund Method</label>
            <div class="d-flex gap-3 mb-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="refundMethod" id="refundUPI" value="upi" checked onchange="toggleRefundMethod()">
                <label class="form-check-label" for="refundUPI">UPI ID</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="refundMethod" id="refundBank" value="bank" onchange="toggleRefundMethod()">
                <label class="form-check-label" for="refundBank">Bank Account</label>
              </div>
            </div>

            <!-- UPI Section -->
            <div id="upiSection">
              <label class="form-label">UPI ID <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="upiId" placeholder="yourname@upi or 9876543210@paytm">
              <small class="text-muted">Example: name@okicici, name@ybl, 9876543210@paytm</small>
            </div>

            <!-- Bank Account Section -->
            <div id="bankSection" style="display: none;">
              <div class="mb-3">
                <label class="form-label">Account Holder Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="accountHolderName" placeholder="As per bank records">
              </div>
              <div class="mb-3">
                <label class="form-label">Bank Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="bankName" placeholder="e.g., HDFC Bank">
              </div>
              <div class="mb-3">
                <label class="form-label">Account Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="accountNumber" placeholder="Enter account number">
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm Account Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="confirmAccountNumber" placeholder="Re-enter account number">
              </div>
              <div class="mb-3">
                <label class="form-label">IFSC Code <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="ifscCode" placeholder="e.g., HDFC0001234" style="text-transform: uppercase;">
              </div>
            </div>
          </div>

          <div class="alert-info-custom mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Refunds are processed within 5-7 business days after we receive your items.
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary flex-fill" onclick="goToStep(2)">
              <i class="bi bi-arrow-left me-1"></i> Back
            </button>
            <button class="btn btn-primary flex-fill" id="submitBtn" onclick="submitReturn()">
              Submit Return Request
            </button>
          </div>
        </div>

        <!-- Step 4: Success -->
        <div class="step-content" id="step4">
          <div class="text-center">
            <div class="success-icon">
              <i class="bi bi-check-lg"></i>
            </div>
            <h2 class="step-title" id="successTitle">Return Request Submitted</h2>
            <p class="step-desc mb-4" id="successDesc">
              Your return request has been submitted successfully.
              We'll review it and get back to you within 24-48 hours.
            </p>

            <div class="alert-info-custom text-start mb-4">
              <strong id="successIdLabel">Return ID:</strong> <span id="successReturnId"></span><br>
              <strong>Order:</strong> <span id="successOrderName"></span>
            </div>

            <p class="text-muted small mb-4" id="successTrackInfo">
              You can track your return status using the Return ID.
            </p>

            <a href="https://kotty.in" class="btn btn-primary">
              Continue Shopping
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <p class="text-muted small">
        Need help? Contact us at <a href="mailto:support@kotty.in">support@kotty.in</a>
      </p>
    </div>
  </div>

  <script>
    let currentStep = 1;
    let orders = [];
    let selectedOrder = null;
    let selectedItems = [];
    let lookupIdentifier = null; // Store what customer entered (email or phone)

    // Step navigation
    function goToStep(step) {
      document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.step-dot').forEach((el, i) => {
        el.classList.remove('active', 'completed');
        if (i + 1 < step) el.classList.add('completed');
        if (i + 1 === step) el.classList.add('active');
      });
      document.getElementById('step' + step).classList.add('active');
      currentStep = step;

      // Update step 3 titles based on mode
      if (step === 3) {
        const title = document.getElementById('step3Title');
        const desc = document.getElementById('step3Desc');
        const submitBtn = document.getElementById('submitBtn');

        if (isRaisingIssue) {
          title.textContent = 'Raise an Issue';
          desc.textContent = 'Tell us about the issue with your order';
          submitBtn.textContent = 'Submit Issue';
        } else {
          title.textContent = 'Select Items to Return';
          desc.textContent = 'Choose which items you want to return and tell us why';
          submitBtn.textContent = 'Submit Return Request';
        }

        // Show bank details section for COD orders
        updateBankDetailsVisibility();
      }
    }

    // Step 1: Lookup orders
    document.getElementById('lookupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const identifier = document.getElementById('identifier').value.trim();
      const lookupBtn = document.getElementById('lookupBtn');
      const errorDiv = document.getElementById('lookupError');

      lookupBtn.disabled = true;
      lookupBtn.innerHTML = '<span class="loading-spinner"></span> Searching...';
      errorDiv.style.display = 'none';

      try {
        const res = await fetch('/returns/api/lookup-orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier })
        });

        const data = await res.json();

        if (data.success && data.orders && data.orders.length > 0) {
          orders = data.orders;
          lookupIdentifier = identifier; // Store what customer entered
          renderOrders();
          goToStep(2);
        } else {
          errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>' +
            (data.message || 'No orders found. Please check your email/phone and try again.');
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Something went wrong. Please try again.';
        errorDiv.style.display = 'block';
      } finally {
        lookupBtn.disabled = false;
        lookupBtn.innerHTML = 'Find My Orders';
      }
    });

    // Render orders
    function renderOrders() {
      const container = document.getElementById('ordersContainer');

      if (orders.length === 0) {
        container.innerHTML = `
          <div class="no-orders">
            <i class="bi bi-inbox"></i>
            <p>No orders found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = orders.map((order, index) => {
        const eligibility = order.returnEligibility || { eligible: true, canRaiseIssue: true };
        const isEligible = eligibility.eligible;
        const canRaiseIssue = eligibility.canRaiseIssue && !isEligible;
        const status = eligibility.status || 'eligible';
        const orderDate = new Date(order.created_at).toLocaleDateString('en-IN', {
          day: 'numeric', month: 'short', year: 'numeric'
        });
        const itemCount = order.line_items?.length || 0;
        const total = parseFloat(order.total_price || 0).toLocaleString('en-IN', {
          style: 'currency', currency: 'INR', minimumFractionDigits: 0
        });

        // Determine status class and text
        let statusClass = 'status-eligible';
        let statusText = 'Eligible for return';

        if (!isEligible) {
          if (status === 'window_expired') {
            statusClass = 'status-can-issue';
            statusText = 'Return window expired';
          } else if (status === 'failed_delivery') {
            statusClass = 'status-ineligible';
            statusText = 'Delivery failed';
          } else if (status === 'in_transit') {
            statusClass = 'status-in-transit';
            statusText = 'In transit';
          } else if (status === 'not_shipped') {
            statusClass = 'status-in-transit';
            statusText = 'Not yet shipped';
          } else {
            statusClass = 'status-ineligible';
            statusText = eligibility.reason || 'Not eligible';
          }
        }

        // Card click behavior
        const cardClickable = isEligible || canRaiseIssue;
        const cardClass = isEligible ? '' : (canRaiseIssue ? '' : 'ineligible');

        return `
          <div class="order-card ${cardClass}"
               data-index="${index}"
               onclick="${cardClickable ? `selectOrder(${index}, ${!isEligible})` : ''}">
            <div class="order-header">
              <div>
                <div class="order-number">Order ${order.name}</div>
                <div class="order-date">${orderDate}</div>
              </div>
              <span class="order-status ${statusClass}">
                ${statusText}
              </span>
            </div>
            <div class="order-summary">
              ${itemCount} item${itemCount !== 1 ? 's' : ''} | ${total}
              ${order.customer_name ? ` | ${order.customer_name}` : ''}
            </div>
            ${canRaiseIssue ? `
              <div class="mt-2">
                <small class="text-muted">${eligibility.reason}</small>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Track if this is an issue (not return)
    let isRaisingIssue = false;

    // Select order
    function selectOrder(index, isIssue = false) {
      selectedOrder = orders[index];
      isRaisingIssue = isIssue;
      document.querySelectorAll('.order-card').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.order-card[data-index="${index}"]`).classList.add('selected');
      document.getElementById('selectOrderBtn').disabled = false;

      // Update button text based on mode
      const selectBtn = document.getElementById('selectOrderBtn');
      selectBtn.innerHTML = isIssue
        ? 'Raise Issue <i class="bi bi-arrow-right ms-1"></i>'
        : 'Continue <i class="bi bi-arrow-right ms-1"></i>';

      // Render items
      renderItems();
    }

    // Render items
    function renderItems() {
      const container = document.getElementById('itemsContainer');

      if (!selectedOrder || !selectedOrder.line_items) {
        container.innerHTML = '<p class="text-muted">No items found</p>';
        return;
      }

      container.innerHTML = selectedOrder.line_items.map((item, index) => {
        const price = parseFloat(item.price || 0).toLocaleString('en-IN', {
          style: 'currency', currency: 'INR', minimumFractionDigits: 0
        });
        const image = item.image_url || null;

        return `
          <div class="item-card">
            <input type="checkbox" class="item-checkbox"
                   id="item${index}" value="${item.id}"
                   onchange="toggleItem(${index})" checked>
            <div class="item-image">
              ${image ? `<img src="${image}" alt="${item.name}">` : '<i class="bi bi-box"></i>'}
            </div>
            <div class="item-details">
              <div class="item-name">${item.name || item.title}</div>
              <div class="item-variant">${item.variant_title || ''} ${item.sku ? '| SKU: ' + item.sku : ''}</div>
            </div>
            <div class="item-price">${price}</div>
          </div>
        `;
      }).join('');

      // Select all items by default
      selectedItems = selectedOrder.line_items.map(item => item.id);
    }

    // Toggle item selection
    function toggleItem(index) {
      const itemId = selectedOrder.line_items[index].id;
      const checkbox = document.getElementById('item' + index);

      if (checkbox.checked) {
        selectedItems.push(itemId);
      } else {
        selectedItems = selectedItems.filter(id => id !== itemId);
      }
    }

    // Check if order is COD
    function isCodOrder(order) {
      if (!order) return false;
      // Check order_type field from lookup response
      if (order.order_type === 'cod') return true;
      // Check financial_status - pending with fulfilled means COD
      if (order.financial_status === 'pending' && order.fulfillment_status === 'fulfilled') return true;
      // Check gateway
      const codGateways = ['cash_on_delivery', 'cod', 'cash on delivery', 'manual'];
      const gateway = (order.gateway || '').toLowerCase();
      return codGateways.some(g => gateway.includes(g));
    }

    // Show/hide bank details section based on order type
    function updateBankDetailsVisibility() {
      const bankSection = document.getElementById('bankDetailsSection');
      if (selectedOrder && isCodOrder(selectedOrder)) {
        bankSection.style.display = 'block';
      } else {
        bankSection.style.display = 'none';
      }
    }

    // Toggle between UPI and Bank account
    function toggleRefundMethod() {
      const upiSection = document.getElementById('upiSection');
      const bankSection = document.getElementById('bankSection');
      const isUPI = document.getElementById('refundUPI').checked;

      upiSection.style.display = isUPI ? 'block' : 'none';
      bankSection.style.display = isUPI ? 'none' : 'block';
    }

    // Validate bank details
    function validateBankDetails() {
      if (!selectedOrder || !isCodOrder(selectedOrder)) {
        return { valid: true, data: null };
      }

      const isUPI = document.getElementById('refundUPI').checked;

      if (isUPI) {
        const upiId = document.getElementById('upiId').value.trim();
        if (!upiId) {
          return { valid: false, error: 'Please enter your UPI ID' };
        }
        // Basic UPI validation
        if (!upiId.includes('@')) {
          return { valid: false, error: 'Please enter a valid UPI ID (e.g., name@upi)' };
        }
        return { valid: true, data: { type: 'upi', upi_id: upiId } };
      } else {
        const accountHolderName = document.getElementById('accountHolderName').value.trim();
        const bankName = document.getElementById('bankName').value.trim();
        const accountNumber = document.getElementById('accountNumber').value.trim();
        const confirmAccountNumber = document.getElementById('confirmAccountNumber').value.trim();
        const ifscCode = document.getElementById('ifscCode').value.trim().toUpperCase();

        if (!accountHolderName) return { valid: false, error: 'Please enter account holder name' };
        if (!bankName) return { valid: false, error: 'Please enter bank name' };
        if (!accountNumber) return { valid: false, error: 'Please enter account number' };
        if (!confirmAccountNumber) return { valid: false, error: 'Please confirm account number' };
        if (accountNumber !== confirmAccountNumber) return { valid: false, error: 'Account numbers do not match' };
        if (!ifscCode) return { valid: false, error: 'Please enter IFSC code' };
        // Basic IFSC validation (11 characters, alphanumeric)
        if (!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(ifscCode)) {
          return { valid: false, error: 'Please enter a valid IFSC code (e.g., HDFC0001234)' };
        }

        return {
          valid: true,
          data: {
            type: 'bank',
            account_holder_name: accountHolderName,
            bank_name: bankName,
            account_number: accountNumber,
            ifsc_code: ifscCode
          }
        };
      }
    }

    // Submit return
    async function submitReturn() {
      const submitBtn = document.getElementById('submitBtn');
      const reason = document.getElementById('returnReason').value;
      const notes = document.getElementById('notes').value;

      if (!reason) {
        alert('Please select a reason for return');
        return;
      }

      if (selectedItems.length === 0) {
        alert('Please select at least one item to return');
        return;
      }

      // Validate bank details for COD orders
      const bankValidation = validateBankDetails();
      if (!bankValidation.valid) {
        alert(bankValidation.error);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';

      try {
        // Determine if lookup was email or phone
        const isEmail = lookupIdentifier && lookupIdentifier.includes('@');
        const customerEmail = isEmail ? lookupIdentifier : (selectedOrder.email || null);
        const customerPhone = !isEmail ? lookupIdentifier : (selectedOrder.customer_phone || null);
        const customerName = selectedOrder.customer_name || selectedOrder.shipping_address?.name || null;

        const res = await fetch('/returns/api/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shopifyOrderId: selectedOrder.id,
            orderName: selectedOrder.name,
            email: customerEmail,
            customerName: customerName,
            customerPhone: customerPhone,
            lookupIdentifier: lookupIdentifier, // Pass what customer entered
            returnReason: reason,
            notes: notes,
            selectedItems: selectedItems,
            source: 'customer_form',
            isIssue: isRaisingIssue,
            bankDetails: bankValidation.data // Include bank details for COD
          })
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById('successReturnId').textContent = data.returnId;
          document.getElementById('successOrderName').textContent = selectedOrder.name;

          // Update success page based on mode
          if (isRaisingIssue) {
            document.getElementById('successTitle').textContent = 'Issue Reported';
            document.getElementById('successDesc').textContent = 'Your issue has been reported successfully. Our team will review it and get back to you within 24-48 hours.';
            document.getElementById('successIdLabel').textContent = 'Ticket ID:';
            document.getElementById('successTrackInfo').textContent = 'You can track your issue status using the Ticket ID.';
          }

          goToStep(4);
        } else {
          if (data.existingReturnId) {
            alert(`A return already exists for this order.\n\nReturn ID: ${data.existingReturnId}\n\nPlease track your existing return or contact support.`);
          } else {
            alert(data.message || 'Failed to submit return request. Please try again.');
          }
        }
      } catch (error) {
        alert('Something went wrong. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit Return Request';
      }
    }
  </script>
</body>
</html>
