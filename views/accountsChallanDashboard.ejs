<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Accounts DC Challan Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/professional.css">
</head>
<body>
  <% const isSapna = user && user.username && user.username.toLowerCase() === 'sapna'; %>
  <nav class="navbar navbar-expand-lg navbar-light app-navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-file-earmark-text me-2"></i>Accounts DC Challan
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <% if (isSapna) { %>
            <li class="nav-item">
              <a class="nav-link" href="/purchase">
                <i class="bi bi-cart-fill"></i> Purchase
              </a>
            </li>
          <% } %>
          <li class="nav-item">
            <a class="nav-link active" href="/accounts-challan">
              <i class="bi bi-file-earmark-text"></i> DC Challan
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/accounts-challan/list">
              <i class="bi bi-list-ul"></i> Challan List
            </a>
          </li>
          <% if (isSapna) { %>
            <li class="nav-item">
              <a class="nav-link" href="/accounts-challan/gst">
                <i class="bi bi-receipt"></i> GST Master
              </a>
            </li>
          <% } %>
          <li class="nav-item">
            <a href="/logout" class="btn btn-outline-secondary btn-sm ms-2">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="app-shell">
    <% if (error && error.length) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <% error.forEach(msg => { %>
          <div><%= msg %></div>
        <% }); %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    <% if (success && success.length) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <% success.forEach(msg => { %>
          <div><%= msg %></div>
        <% }); %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Tab Navigation -->
    <ul class="nav nav-pills app-tabs mb-4">
      <% if (isSapna) { %>
        <li class="nav-item">
          <a class="nav-link" href="/purchase">
            <i class="bi bi-cart-fill"></i> Purchase
          </a>
        </li>
      <% } %>
      <li class="nav-item">
        <a class="nav-link active" href="/accounts-challan">
          <i class="bi bi-file-earmark-text"></i> DC Challan
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/accounts-challan/list">
          <i class="bi bi-list-ul"></i> Challan List
        </a>
      </li>
      <% if (isSapna) { %>
        <li class="nav-item">
          <a class="nav-link" href="/accounts-challan/gst">
            <i class="bi bi-receipt"></i> GST Master
          </a>
        </li>
      <% } %>
    </ul>

    <!-- Hero Section -->
    <div class="page-hero">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
          <h2 class="mb-2">
            <i class="bi bi-file-earmark-text me-2"></i>DC Challan Dashboard
          </h2>
          <p class="mb-3 opacity-90">Select lots with remaining pieces, enter quantities, and generate delivery challans.</p>
          <div class="hero-note">
            <i class="bi bi-info-circle me-2"></i>Only lots with remaining pieces are shown
          </div>
        </div>
        <div class="hero-actions">
          <button id="selectAllBtn" class="btn btn-soft icon-btn" data-bs-toggle="tooltip" title="Select or deselect all visible lots">
            <i class="bi bi-check-all me-1"></i> Select All
          </button>
          <button id="generateChallanBtn" class="btn btn-success icon-btn" disabled data-bs-toggle="tooltip" title="Generate challan for selected lots">
            <i class="bi bi-file-earmark-plus me-1"></i> Generate Challan
          </button>
        </div>
      </div>
    </div>

    <!-- Search Controls -->
    <div class="search-controls mb-4">
      <div class="row align-items-end g-3">
        <div class="col-md-8">
          <label class="form-label fw-semibold mb-2">
            <i class="bi bi-search me-2"></i>Search Lots
          </label>
          <input
            type="text"
            id="searchInput"
            class="form-control form-control-lg"
            placeholder="Search by SKU, Lot No, or Cutting Remark..."
            value="<%= search %>"
            data-bs-toggle="tooltip"
            title="Type to search lots by SKU, lot number, or remarks"
          />
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary btn-lg w-100 icon-btn" id="searchBtn">
            <i class="bi bi-search me-2"></i> Search
          </button>
        </div>
      </div>
    </div>

    <!-- Lots Table Card -->
    <div class="surface-card table-card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-box-seam me-2"></i>Lots Awaiting Challan
          </h5>
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>Pick lots and set challan pieces
          </small>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0" id="assignmentsTable">
            <thead class="table-light">
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="selectAllCheckbox" data-bs-toggle="tooltip" title="Select/Deselect all">
                </th>
                <th><i class="bi bi-hash me-1"></i>ID</th>
                <th><i class="bi bi-tag me-1"></i>Lot No</th>
                <th><i class="bi bi-upc me-1"></i>SKU</th>
            <th><i class="bi bi-box me-1"></i>Total Pieces</th>
            <th><i class="bi bi-send me-1"></i>Issued (Normal)</th>
            <th><i class="bi bi-box-seam me-1"></i>Remaining</th>
            <th><i class="bi bi-shuffle me-1"></i>Type</th>
            <th><i class="bi bi-input-cursor-text me-1"></i>Challan Qty</th>
                <th><i class="bi bi-chat-left-text me-1"></i>Assembly Remark</th>
                <th><i class="bi bi-scissors me-1"></i>Cutting Remark</th>
                <th><i class="bi bi-calendar-event me-1"></i>Target Day</th>
                <th><i class="bi bi-clock me-1"></i>Assigned On</th>
                <th><i class="bi bi-person me-1"></i>Washer</th>
                <th><i class="bi bi-person-badge me-1"></i>Master</th>
              </tr>
            </thead>
            <tbody>
              <% if (assignments && assignments.length) { %>
                <% assignments.forEach(a => { %>
                  <tr
                    data-id="<%= a.washing_id %>"
                    data-lot="<%= a.lot_no %>"
                    data-sku="<%= a.sku %>"
                    data-total="<%= a.total_pieces %>"
                    data-remaining="<%= a.remaining_pieces %>"
                  >
                    <td><input type="checkbox" class="rowCheckbox"></td>
                    <td><%= a.washing_id %></td>
                    <td><%= a.lot_no %></td>
                    <td><%= a.sku %></td>
                    <td><%= a.total_pieces %></td>
                    <td><%= a.issued_pieces %></td>
                    <td><span class="badge badge-info"><%= a.remaining_pieces %></span></td>
                    <td>
                      <select class="form-select form-select-sm challan-type">
                        <option value="normal" <%= a.remaining_pieces > 0 ? 'selected' : '' %>>Normal</option>
                        <option value="rewash" <%= a.remaining_pieces <= 0 ? 'selected' : '' %>>Rewash</option>
                      </select>
                      <small class="text-muted">Rewash allows repeated lots</small>
                    </td>
                    <td>
                      <input
                        type="number"
                        class="form-control form-control-sm qty-input challan-qty"
                        min="1"
                        max="<%= a.total_pieces %>"
                        value="<%= a.remaining_pieces > 0 ? a.remaining_pieces : a.total_pieces %>"
                      />
                    </td>
                    <td><%= a.assembly_remark %></td>
                    <td><%= a.cutting_remark %></td>
                    <td><%= a.target_day ? new Date(a.target_day).toLocaleDateString() : '' %></td>
                    <td><%= a.assigned_on ? new Date(a.assigned_on).toLocaleString() : '' %></td>
                    <td><%= a.washer_username %></td>
                    <td><%= a.master_username %></td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr id="noRecordsRow">
                  <td colspan="15" class="text-center">No records found.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="text-center my-4">
      <button class="btn btn-outline-primary btn-lg icon-btn" id="loadMoreBtn" data-bs-toggle="tooltip" title="Load more lots">
        <i class="bi bi-arrow-down-circle me-2"></i>Load More
      </button>
    </div>

    <form id="generateForm" action="/accounts-challan/generate" method="POST" class="d-none">
      <input type="hidden" name="selectedRows" id="selectedRowsInput">
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentOffset = 0;
    let currentSearchQuery = '<%= search %>';

    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const generateChallanBtn = document.getElementById('generateChallanBtn');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');

    function updateGenerateButton() {
      const anyChecked = document.querySelectorAll('.rowCheckbox:checked').length > 0;
      generateChallanBtn.disabled = !anyChecked;
    }

    function attachRowListeners() {
      document.querySelectorAll('.rowCheckbox').forEach(cb => {
        cb.addEventListener('change', updateGenerateButton);
      });
    }

    function renderRows(assignments, append = false) {
      const tbody = document.querySelector('#assignmentsTable tbody');
      if (!append) {
        tbody.innerHTML = '';
      }
      if (!assignments.length && !append) {
        tbody.innerHTML = '<tr><td colspan="15" class="text-center">No records found.</td></tr>';
        return;
      }

      assignments.forEach(a => {
        const row = document.createElement('tr');
        row.dataset.id = a.washing_id;
        row.dataset.lot = a.lot_no;
        row.dataset.sku = a.sku;
        row.dataset.total = a.total_pieces;
        row.dataset.remaining = a.remaining_pieces;
        row.innerHTML = `
          <td><input type="checkbox" class="rowCheckbox"></td>
          <td>${a.washing_id}</td>
          <td>${a.lot_no}</td>
          <td>${a.sku}</td>
          <td>${a.total_pieces}</td>
          <td>${a.issued_pieces}</td>
          <td><span class="badge badge-info">${a.remaining_pieces}</span></td>
          <td>
            <select class="form-select form-select-sm challan-type">
              <option value="normal" ${a.remaining_pieces > 0 ? 'selected' : ''}>Normal</option>
              <option value="rewash" ${a.remaining_pieces <= 0 ? 'selected' : ''}>Rewash</option>
            </select>
            <small class="text-muted">Rewash allows repeated lots</small>
          </td>
          <td>
            <input
              type="number"
              class="form-control form-control-sm qty-input challan-qty"
              min="1"
              max="${a.total_pieces}"
              value="${a.remaining_pieces > 0 ? a.remaining_pieces : a.total_pieces}"
            />
          </td>
          <td>${a.assembly_remark || ''}</td>
          <td>${a.cutting_remark || ''}</td>
          <td>${a.target_day ? new Date(a.target_day).toLocaleDateString() : ''}</td>
          <td>${a.assigned_on ? new Date(a.assigned_on).toLocaleString() : ''}</td>
          <td>${a.washer_username}</td>
          <td>${a.master_username}</td>
        `;
        tbody.appendChild(row);
      });
      attachRowListeners();
      updateGenerateButton();
    }

    selectAllBtn.addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.rowCheckbox');
      const shouldSelectAll = !selectAllCheckbox.checked;
      selectAllCheckbox.checked = shouldSelectAll;
      checkboxes.forEach(cb => cb.checked = shouldSelectAll);
      updateGenerateButton();
    });

    selectAllCheckbox.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('.rowCheckbox');
      checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
      updateGenerateButton();
    });

    searchBtn.addEventListener('click', async () => {
      currentOffset = 0;
      currentSearchQuery = searchInput.value.trim();
      const url = `/accounts-challan/search?search=${encodeURIComponent(currentSearchQuery)}&offset=${currentOffset}`;
      const res = await fetch(url);
      const data = await res.json();
      renderRows(data.assignments || [], false);
    });

    loadMoreBtn.addEventListener('click', async () => {
      currentOffset += 50;
      const url = `/accounts-challan/search?search=${encodeURIComponent(currentSearchQuery)}&offset=${currentOffset}`;
      const res = await fetch(url);
      const data = await res.json();
      renderRows(data.assignments || [], true);
    });

    generateChallanBtn.addEventListener('click', () => {
      const selected = [];
      let hasInvalid = false;
      const rows = document.querySelectorAll('#assignmentsTable tbody tr');
      rows.forEach(row => {
        const checkbox = row.querySelector('.rowCheckbox');
        if (!checkbox || !checkbox.checked) return;

        const remaining = parseInt(row.dataset.remaining, 10);
        const qtyInput = row.querySelector('.challan-qty');
        const totalPieces = parseInt(row.dataset.total, 10);
        const itemType = row.querySelector('.challan-type')?.value || 'normal';
        const maxAllowed = itemType === 'rewash' ? totalPieces : remaining;
        const qty = parseInt(qtyInput.value, 10);
        if (!qty || qty <= 0 || qty > maxAllowed) {
          alert(`Invalid challan pieces for lot ${row.dataset.lot}.`);
          hasInvalid = true;
          return;
        }
        selected.push({
          washing_id: row.dataset.id,
          lot_no: row.dataset.lot,
          sku: row.dataset.sku,
          total_pieces: row.dataset.total,
          challan_pieces: qty,
          entryType: itemType,
          itemType
        });
      });

      if (hasInvalid) {
        return;
      }
      if (!selected.length) {
        alert('Please select at least one lot.');
        return;
      }

      document.getElementById('selectedRowsInput').value = JSON.stringify(selected);
      document.getElementById('generateForm').submit();
    });

    attachRowListeners();

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  </script>
</body>
</html>
