<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mail Manager - Kotty Track</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/professional.css">
  <style>
    .email-row { cursor: pointer; transition: background-color 0.15s; }
    .email-row:hover { background-color: #f8f9fa; }
    .email-row.selected { background-color: #e7f3ff; }
    .classification-badge { font-size: 0.75rem; }
    .badge-initial { background-color: #0d6efd; }
    .badge-closed { background-color: #198754; }
    .badge-proceeding { background-color: #ffc107; color: #000; }
    .badge-replied { background-color: #20c997; }
    .badge-error { background-color: #dc3545; }
    .badge-unknown { background-color: #6c757d; }
    .email-checkbox { width: 18px; height: 18px; cursor: pointer; }
    .bulk-actions { display: none; }
    .bulk-actions.show { display: flex; }
    .email-preview { max-height: 400px; overflow-y: auto; }
    .video-card { border-left: 4px solid #198754; }
    .upload-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.2s; }
    .upload-zone.drag-over { border-color: #0d6efd; background-color: #e7f3ff; }
    .mapping-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand"><i class="bi bi-envelope-paper me-2"></i>Mail Manager</span>
    <div class="d-flex align-items-center gap-3">
      <a href="/video-finder" class="btn btn-outline-light btn-sm">
        <i class="bi bi-camera-video me-1"></i>Video Finder
      </a>
      <span class="text-white"><%= user?.username %></span>
    </div>
  </div>
</nav>

<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- Left Column: Mapping & Search -->
    <div class="col-lg-4">
      <!-- Zoho Status -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Zoho Mail Status</span>
            <% if (zohoStatus.connected) { %>
              <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Connected</span>
            <% } else if (zohoStatus.configured) { %>
              <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Not Connected</span>
            <% } else { %>
              <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Not Configured</span>
            <% } %>
          </div>
          <% if (!zohoStatus.configured) { %>
            <small class="text-muted d-block mt-2">Set ZOHO_CLIENT_ID, ZOHO_CLIENT_SECRET, ZOHO_REFRESH_TOKEN env vars</small>
          <% } %>
        </div>
      </div>

      <!-- Excel Mapping Upload -->
      <div class="card mb-3">
        <div class="card-header bg-white">
          <i class="bi bi-file-earmark-spreadsheet me-2"></i>Order-to-AWB Mapping
        </div>
        <div class="card-body">
          <div id="uploadZone" class="upload-zone mb-3">
            <i class="bi bi-cloud-upload fs-2 text-muted"></i>
            <p class="mb-1">Drop Excel file here or click to browse</p>
            <small class="text-muted">Columns needed: Order ID, AWB</small>
            <input type="file" id="mappingFile" accept=".xlsx,.xls,.csv" class="d-none">
          </div>
          <div id="mappingStatus" class="<%= mappingCount > 0 ? '' : 'd-none' %>">
            <div class="mapping-info text-white p-3 rounded mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <span><i class="bi bi-database me-2"></i><span id="mappingCountDisplay"><%= mappingCount %></span> mappings loaded</span>
                <button class="btn btn-sm btn-outline-light" onclick="clearMapping()">Clear</button>
              </div>
            </div>
          </div>
          <div id="uploadProgress" class="d-none">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Uploading...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Manual AWB Lookup -->
      <div class="card mb-3">
        <div class="card-header bg-white">
          <i class="bi bi-search me-2"></i>AWB Lookup
        </div>
        <div class="card-body">
          <div class="input-group">
            <input type="text" id="lookupOrderId" class="form-control" placeholder="Enter Order ID...">
            <button class="btn btn-primary" onclick="lookupAwb()">Lookup</button>
          </div>
          <div id="lookupResult" class="mt-2 d-none"></div>
        </div>
      </div>

      <!-- Email Search -->
      <div class="card">
        <div class="card-header bg-white">
          <i class="bi bi-envelope-open me-2"></i>Search Emails
        </div>
        <div class="card-body">
          <div class="input-group mb-2">
            <input type="text" id="emailSearch" class="form-control" placeholder="Search emails (e.g., CCTV, order ID)..." value="cctv">
            <button class="btn btn-primary" onclick="searchEmails()">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label small text-muted mb-1">From Date</label>
              <input type="date" id="searchDateFrom" class="form-control form-control-sm">
            </div>
            <div class="col-6">
              <label class="form-label small text-muted mb-1">To Date</label>
              <input type="date" id="searchDateTo" class="form-control form-control-sm">
            </div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-secondary" onclick="loadInbox()">Load Inbox</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="searchEmails('cctv')">CCTV Requests</button>
            <button class="btn btn-sm btn-outline-info" onclick="setDateToday()">Today</button>
            <button class="btn btn-sm btn-outline-info" onclick="setDateLastWeek()">Last 7 Days</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Column: Email List -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span><i class="bi bi-inbox me-2"></i>Emails</span>
            <span id="emailCount" class="badge bg-secondary">0</span>
          </div>
          <!-- Bulk Actions -->
          <div id="bulkActions" class="bulk-actions gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-primary" onclick="selectAllInitial()">
              <i class="bi bi-check-all me-1"></i>Select Initial
            </button>
            <button class="btn btn-sm btn-success" onclick="startBulkReply()" id="bulkReplyBtn" disabled>
              <i class="bi bi-send me-1"></i>Bulk Reply (<span id="selectedCount">0</span>)
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="exportSelected()" id="exportBtn" disabled>
              <i class="bi bi-download me-1"></i>Export
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear</button>
          </div>
        </div>
        <div class="card-body p-0" style="max-height: 65vh; overflow-y: auto;">
          <div id="emailList">
            <div class="text-center text-muted p-4">
              <i class="bi bi-envelope-slash fs-1"></i>
              <p class="mt-2">Search for emails to get started</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Email Details & Reply -->
    <div class="col-lg-4">
      <div id="emailDetails" class="d-none">
        <!-- Email Header -->
        <div class="card mb-3">
          <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 id="detailSubject" class="mb-1">Subject</h6>
                <small id="detailFrom" class="text-muted">From</small>
              </div>
              <span id="detailClassification" class="badge"></span>
            </div>
          </div>
          <div class="card-body email-preview">
            <div id="detailContent"></div>
          </div>
        </div>

        <!-- Extracted Details -->
        <div class="card mb-3">
          <div class="card-header bg-white">
            <i class="bi bi-info-circle me-2"></i>Extracted Details
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label small text-muted">Order ID <span class="text-primary">(key for AWB lookup)</span></label>
                <input type="text" id="extractedOrderId" class="form-control form-control-sm fw-bold" readonly>
              </div>
              <div class="col-6">
                <label class="form-label small text-muted">Outbound AWB <span class="text-success">(from mapping)</span></label>
                <div class="input-group input-group-sm">
                  <input type="text" id="extractedOutboundAwb" class="form-control fw-bold">
                  <button class="btn btn-outline-primary" onclick="findVideosForEmail()" title="Search videos">
                    <i class="bi bi-camera-video"></i>
                  </button>
                </div>
              </div>
              <div class="col-6">
                <label class="form-label small text-muted">Return AWB <span class="text-danger">(not for video search)</span></label>
                <input type="text" id="extractedReturnAwb" class="form-control form-control-sm text-muted" readonly>
              </div>
              <div class="col-6">
                <label class="form-label small text-muted">Ticket</label>
                <input type="text" id="extractedTicket" class="form-control form-control-sm" readonly>
              </div>
            </div>
            <div id="mappingWarning" class="alert alert-warning mt-2 mb-0 py-2 d-none">
              <i class="bi bi-exclamation-triangle me-1"></i>
              <span id="mappingWarningText">Upload Excel mapping to lookup AWB from Order ID</span>
            </div>
          </div>
        </div>

        <!-- Found Videos -->
        <div id="videoResults" class="card mb-3 d-none">
          <div class="card-header bg-white">
            <i class="bi bi-film me-2"></i>Found Videos
          </div>
          <div class="card-body" id="videoList"></div>
        </div>

        <!-- Reply Section -->
        <div class="card">
          <div class="card-header bg-white">
            <i class="bi bi-reply me-2"></i>Send Reply
          </div>
          <div class="card-body">
            <button id="sendReplyBtn" class="btn btn-success w-100" onclick="sendReply()" disabled>
              <i class="bi bi-send me-2"></i>Send Reply with Video Links
            </button>
            <div id="replyStatus" class="mt-2 d-none"></div>
          </div>
        </div>
      </div>

      <!-- Placeholder when no email selected -->
      <div id="noEmailSelected" class="text-center text-muted p-4">
        <i class="bi bi-cursor fs-1"></i>
        <p class="mt-2">Select an email to view details</p>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Reply Progress Modal -->
<div class="modal fade" id="bulkReplyModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-send me-2"></i>Bulk Reply Progress</h5>
      </div>
      <div class="modal-body">
        <div id="bulkProgress">
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Progress</span>
              <span id="bulkProgressText">0 / 0</span>
            </div>
            <div class="progress">
              <div id="bulkProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>
          </div>
          <div class="row g-2 text-center mb-3">
            <div class="col-4 col-md-2">
              <div class="border rounded p-2">
                <div id="bulkStatSuccess" class="fs-5 fw-bold text-success">0</div>
                <small class="text-muted">Replied</small>
              </div>
            </div>
            <div class="col-4 col-md-2">
              <div class="border rounded p-2">
                <div id="bulkStatNoOrderId" class="fs-5 fw-bold text-info">0</div>
                <small class="text-muted">No Order</small>
              </div>
            </div>
            <div class="col-4 col-md-2">
              <div class="border rounded p-2">
                <div id="bulkStatNoMapping" class="fs-5 fw-bold text-primary">0</div>
                <small class="text-muted">No AWB</small>
              </div>
            </div>
            <div class="col-4 col-md-2">
              <div class="border rounded p-2">
                <div id="bulkStatNoVideo" class="fs-5 fw-bold text-warning">0</div>
                <small class="text-muted">No Video</small>
              </div>
            </div>
            <div class="col-4 col-md-2">
              <div class="border rounded p-2">
                <div id="bulkStatFailed" class="fs-5 fw-bold text-danger">0</div>
                <small class="text-muted">Failed</small>
              </div>
            </div>
            <div class="col-4 col-md-2">
              <div class="border rounded p-2">
                <div id="bulkStatSkipped" class="fs-5 fw-bold text-secondary">0</div>
                <small class="text-muted">Skipped</small>
              </div>
            </div>
          </div>
          <div id="bulkReplyLog" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem;">
            <div class="text-muted text-center">Waiting to start...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cancelBulkReply()" id="bulkCancelBtn">Cancel</button>
        <button type="button" class="btn btn-primary d-none" onclick="closeBulkModal()" id="bulkDoneBtn">Done</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Current state
let currentEmail = null;
let foundVideos = [];
let emailData = []; // Store loaded emails for selection
let selectedEmails = new Set(); // Track selected message IDs
let bulkEventSource = null; // For SSE connection
let lastSearchQuery = '';
let lastSearchStart = 0;

// ==================== FILE UPLOAD ====================

const uploadZone = document.getElementById('uploadZone');
const mappingFile = document.getElementById('mappingFile');

uploadZone.addEventListener('click', () => mappingFile.click());

uploadZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', () => {
  uploadZone.classList.remove('drag-over');
});

uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  if (e.dataTransfer.files.length) {
    uploadMapping(e.dataTransfer.files[0]);
  }
});

mappingFile.addEventListener('change', (e) => {
  if (e.target.files.length) {
    uploadMapping(e.target.files[0]);
  }
});

async function uploadMapping(file) {
  const progress = document.getElementById('uploadProgress');
  const status = document.getElementById('mappingStatus');
  const countDisplay = document.getElementById('mappingCountDisplay');

  progress.classList.remove('d-none');

  try {
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch('/mail-manager/upload-mapping', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();

    if (data.success) {
      countDisplay.textContent = data.count;
      status.classList.remove('d-none');
      showToast('Loaded ' + data.count + ' mappings', 'success');
    } else {
      showToast(data.error || 'Upload failed', 'danger');
    }
  } catch (err) {
    showToast('Upload error: ' + err.message, 'danger');
  } finally {
    progress.classList.add('d-none');
    mappingFile.value = '';
  }
}

async function clearMapping() {
  try {
    await fetch('/mail-manager/clear-mapping', { method: 'POST' });
    document.getElementById('mappingStatus').classList.add('d-none');
    showToast('Mapping cleared', 'info');
  } catch (err) {
    showToast('Failed to clear mapping', 'danger');
  }
}

// ==================== AWB LOOKUP ====================

async function lookupAwb() {
  const orderId = document.getElementById('lookupOrderId').value.trim();
  const resultDiv = document.getElementById('lookupResult');

  if (!orderId) {
    showToast('Enter an Order ID', 'warning');
    return;
  }

  try {
    const res = await fetch('/mail-manager/lookup-awb/' + encodeURIComponent(orderId));
    const data = await res.json();

    resultDiv.classList.remove('d-none');
    if (data.found) {
      resultDiv.innerHTML = '<div class="alert alert-success mb-0 py-2">AWB: <strong>' + data.awb + '</strong></div>';
    } else {
      resultDiv.innerHTML = '<div class="alert alert-warning mb-0 py-2">' + (data.error || 'No AWB found') + '</div>';
    }
  } catch (err) {
    resultDiv.classList.remove('d-none');
    resultDiv.innerHTML = '<div class="alert alert-danger mb-0 py-2">Lookup failed</div>';
  }
}

// ==================== EMAIL SEARCH ====================

function setDateToday() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('searchDateFrom').value = today;
  document.getElementById('searchDateTo').value = today;
}

function setDateLastWeek() {
  const today = new Date();
  const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById('searchDateFrom').value = lastWeek.toISOString().split('T')[0];
  document.getElementById('searchDateTo').value = today.toISOString().split('T')[0];
}

async function searchEmails(query, append = false) {
  const searchInput = document.getElementById('emailSearch');
  const searchQuery = query || searchInput.value.trim();
  const dateFrom = document.getElementById('searchDateFrom').value;
  const dateTo = document.getElementById('searchDateTo').value;

  if (!searchQuery) {
    showToast('Enter a search query', 'warning');
    return;
  }

  searchInput.value = searchQuery;

  // Track for "Load More"
  if (!append) {
    lastSearchQuery = searchQuery;
    lastSearchStart = 0;
    document.getElementById('emailList').innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
  }

  try {
    let url = '/mail-manager/emails/search?query=' + encodeURIComponent(searchQuery) + '&limit=200&start=' + lastSearchStart;
    if (dateFrom) url += '&fromDate=' + dateFrom;
    if (dateTo) url += '&toDate=' + dateTo;

    const res = await fetch(url);
    const data = await res.json();

    let emails = data.emails || [];

    // Update pagination
    lastSearchStart += emails.length;

    // Append or replace
    if (append) {
      emailData = [...emailData, ...emails];
    } else {
      emailData = emails;
    }

    renderEmailList(emailData, emails.length >= 200); // Show load more if we got full page
  } catch (err) {
    document.getElementById('emailList').innerHTML = '<div class="alert alert-danger m-3">Search failed: ' + err.message + '</div>';
  }
}

async function loadMoreEmails() {
  if (lastSearchQuery) {
    await searchEmails(lastSearchQuery, true);
  }
}

async function loadInbox() {
  document.getElementById('emailList').innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';

  try {
    const res = await fetch('/mail-manager/emails/inbox');
    const data = await res.json();

    renderEmailList(data.emails || []);
  } catch (err) {
    document.getElementById('emailList').innerHTML = '<div class="alert alert-danger m-3">Failed to load inbox: ' + err.message + '</div>';
  }
}

function renderEmailList(emails, showLoadMore = false) {
  const list = document.getElementById('emailList');
  const count = document.getElementById('emailCount');

  count.textContent = emails.length;
  emailData = emails; // Store for selection

  // Show bulk actions bar
  document.getElementById('bulkActions').classList.toggle('show', emails.length > 0);

  if (!emails.length) {
    list.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-inbox fs-1"></i><p class="mt-2">No emails found</p></div>';
    return;
  }

  let html = emails.map((email, idx) => {
    const isReplied = email.classification === 'replied' || email.dbStatus?.status === 'replied';
    const badgeClass = email.classification || 'unknown';
    const badgeText = email.classification || '?';
    const repliedInfo = email.dbStatus?.repliedAt ? ' (' + new Date(email.dbStatus.repliedAt).toLocaleDateString() + ')' : '';

    return `
    <div class="email-row p-3 border-bottom d-flex align-items-start gap-2" data-message-id="${email.messageId}" data-classification="${email.classification}">
      <input type="checkbox" class="email-checkbox mt-1"
        onchange="toggleEmailSelection('${email.messageId}')"
        ${isReplied ? 'disabled title="Already replied"' : ''}
        ${selectedEmails.has(email.messageId) ? 'checked' : ''}>
      <div class="flex-grow-1 overflow-hidden" onclick="loadEmailDetails('${email.messageId}', this.parentElement)">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1 overflow-hidden">
            <div class="fw-semibold text-truncate">${escapeHtml(email.subject || '(No Subject)')}</div>
            <small class="text-muted">${escapeHtml(email.fromAddress || email.sender || '')}</small>
          </div>
          <span class="badge classification-badge badge-${badgeClass}">${badgeText}${repliedInfo}</span>
        </div>
        <small class="text-muted">${email.receivedTime ? new Date(parseInt(email.receivedTime)).toLocaleString() : ''}</small>
      </div>
    </div>
  `}).join('');

  // Add "Load More" button if there might be more results
  if (showLoadMore) {
    html += `
      <div class="text-center p-3">
        <button class="btn btn-outline-primary btn-sm" onclick="loadMoreEmails()">
          <i class="bi bi-arrow-down-circle me-1"></i>Load More Emails
        </button>
      </div>
    `;
  }

  list.innerHTML = html;
  updateSelectionUI();
}

// ==================== EMAIL DETAILS ====================

async function loadEmailDetails(messageId, rowEl) {
  // Highlight selected row
  document.querySelectorAll('.email-row').forEach(r => r.classList.remove('selected'));
  if (rowEl) rowEl.classList.add('selected');

  document.getElementById('noEmailSelected').classList.add('d-none');
  document.getElementById('emailDetails').classList.remove('d-none');
  document.getElementById('videoResults').classList.add('d-none');
  document.getElementById('mappingWarning').classList.add('d-none');
  foundVideos = [];

  try {
    const res = await fetch('/mail-manager/emails/' + messageId);
    const data = await res.json();

    currentEmail = { messageId, ...data.details, extracted: data.extracted };

    document.getElementById('detailSubject').textContent = data.details?.subject || '(No Subject)';
    document.getElementById('detailFrom').textContent = data.details?.fromAddress || '';
    document.getElementById('detailContent').innerHTML = data.content?.content || '<em>No content</em>';

    // Classification badge
    const classBadge = document.getElementById('detailClassification');
    classBadge.textContent = data.classification || 'unknown';
    classBadge.className = 'badge classification-badge badge-' + (data.classification || 'unknown');

    // Extracted details - Order ID is key, Outbound AWB comes from mapping
    document.getElementById('extractedOrderId').value = data.extracted?.orderId || '';
    document.getElementById('extractedOutboundAwb').value = data.extracted?.outboundAwb || '';
    document.getElementById('extractedReturnAwb').value = data.extracted?.returnAwb || '';
    document.getElementById('extractedTicket').value = data.extracted?.ticket || '';

    // Show warning if we have Order ID but no mapping
    const mappingWarning = document.getElementById('mappingWarning');
    const warningText = document.getElementById('mappingWarningText');
    if (data.extracted?.orderId && !data.extracted?.outboundAwb) {
      if (!data.hasMappingLoaded) {
        warningText.textContent = 'Upload Excel mapping to lookup AWB from Order ID';
      } else {
        warningText.textContent = 'Order ID not found in mapping (' + data.mappingCount + ' entries loaded)';
      }
      mappingWarning.classList.remove('d-none');
    }

    // Reset reply button
    document.getElementById('sendReplyBtn').disabled = true;
    document.getElementById('replyStatus').classList.add('d-none');

    // AUTO-SEARCH for videos if Outbound AWB was found from mapping
    if (data.extracted?.outboundAwb) {
      console.log('Auto-searching for videos with Outbound AWB:', data.extracted.outboundAwb);
      findVideosForEmail();
    }

  } catch (err) {
    showToast('Failed to load email: ' + err.message, 'danger');
  }
}

// ==================== VIDEO SEARCH ====================

async function findVideosForEmail() {
  const orderId = document.getElementById('extractedOrderId').value.trim();
  const outboundAwb = document.getElementById('extractedOutboundAwb').value.trim();

  // Outbound AWB takes priority (either from mapping or manually entered)
  // If no outbound AWB but have Order ID, backend will look up from mapping
  if (!outboundAwb && !orderId) {
    showToast('Need Order ID or Outbound AWB', 'warning');
    return;
  }

  const videoResults = document.getElementById('videoResults');
  const videoList = document.getElementById('videoList');

  videoResults.classList.remove('d-none');
  videoList.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Searching S3...</div>';

  try {
    const res = await fetch('/mail-manager/find-videos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId, awb: outboundAwb })
    });

    const data = await res.json();

    if (data.found && data.videos?.length) {
      foundVideos = data.videos.map(v => ({ ...v, awb: data.awb }));

      // Update the outbound AWB field if it was looked up from mapping
      if (data.awb && !outboundAwb) {
        document.getElementById('extractedOutboundAwb').value = data.awb;
        document.getElementById('mappingWarning').classList.add('d-none');
      }

      videoList.innerHTML = `
        <div class="small text-muted mb-2">AWB: <strong>${escapeHtml(data.awb)}</strong> (${data.awbSource || 'provided'})</div>
        ${foundVideos.map((v, i) => `
        <div class="video-card card mb-2">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">${escapeHtml(v.filename)}</div>
                <small class="text-muted">${formatSize(v.size)}</small>
              </div>
              <a href="${v.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-download"></i>
              </a>
            </div>
          </div>
        </div>
      `).join('')}`;

      // Enable reply button
      document.getElementById('sendReplyBtn').disabled = false;
      showToast('Found ' + foundVideos.length + ' video(s) for AWB ' + data.awb, 'success');
    } else {
      foundVideos = [];
      videoList.innerHTML = '<div class="alert alert-warning mb-0">' + (data.error || 'No videos found') + '</div>';
      document.getElementById('sendReplyBtn').disabled = true;
    }
  } catch (err) {
    videoList.innerHTML = '<div class="alert alert-danger mb-0">Search failed: ' + err.message + '</div>';
  }
}

// ==================== REPLY ====================

async function sendReply() {
  if (!currentEmail || !foundVideos.length) {
    showToast('No email or videos selected', 'warning');
    return;
  }

  const btn = document.getElementById('sendReplyBtn');
  const status = document.getElementById('replyStatus');
  const orderId = document.getElementById('extractedOrderId').value;
  const outboundAwb = document.getElementById('extractedOutboundAwb').value;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

  try {
    const res = await fetch('/mail-manager/reply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messageId: currentEmail.messageId,
        threadId: currentEmail.threadId,
        toAddress: currentEmail.fromAddress,
        subject: currentEmail.subject,
        orderId: orderId,
        outboundAwb: outboundAwb,
        videos: foundVideos
      })
    });

    const data = await res.json();

    status.classList.remove('d-none');
    if (data.success) {
      status.innerHTML = '<div class="alert alert-success mb-0 py-2"><i class="bi bi-check-circle me-2"></i>Reply sent successfully! (Order: ' + escapeHtml(data.orderId || orderId) + ', AWB: ' + escapeHtml(data.awb || outboundAwb) + ')</div>';
      btn.innerHTML = '<i class="bi bi-check me-2"></i>Sent';
    } else {
      status.innerHTML = '<div class="alert alert-danger mb-0 py-2">' + (data.error || 'Failed to send') + '</div>';
      btn.innerHTML = '<i class="bi bi-send me-2"></i>Send Reply with Video Links';
      btn.disabled = false;
    }
  } catch (err) {
    status.classList.remove('d-none');
    status.innerHTML = '<div class="alert alert-danger mb-0 py-2">Error: ' + err.message + '</div>';
    btn.innerHTML = '<i class="bi bi-send me-2"></i>Send Reply with Video Links';
    btn.disabled = false;
  }
}

// ==================== UTILITIES ====================

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function formatSize(bytes) {
  if (!bytes) return 'Unknown';
  const mb = bytes / (1024 * 1024);
  return mb.toFixed(2) + ' MB';
}

function showToast(message, type = 'info') {
  // Simple alert-based toast (can be replaced with Bootstrap toast)
  const alertDiv = document.createElement('div');
  alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
  alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
  alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
  document.body.appendChild(alertDiv);
  setTimeout(() => alertDiv.remove(), 4000);
}

// Keyboard shortcut: Enter to search
document.getElementById('emailSearch').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') searchEmails();
});

document.getElementById('lookupOrderId').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') lookupAwb();
});

// ==================== BULK SELECTION & REPLY ====================

function toggleEmailSelection(messageId) {
  if (selectedEmails.has(messageId)) {
    selectedEmails.delete(messageId);
  } else {
    selectedEmails.add(messageId);
  }
  updateSelectionUI();
}

function selectAllInitial() {
  // Select all emails with classification "initial" that aren't already replied
  emailData.forEach(email => {
    if (email.classification === 'initial' && email.dbStatus?.status !== 'replied') {
      selectedEmails.add(email.messageId);
    }
  });

  // Update checkboxes
  document.querySelectorAll('.email-row').forEach(row => {
    const msgId = row.dataset.messageId;
    const checkbox = row.querySelector('.email-checkbox');
    if (checkbox && selectedEmails.has(msgId)) {
      checkbox.checked = true;
    }
  });

  updateSelectionUI();
}

function clearSelection() {
  selectedEmails.clear();
  document.querySelectorAll('.email-checkbox').forEach(cb => cb.checked = false);
  updateSelectionUI();
}

function updateSelectionUI() {
  const count = selectedEmails.size;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('bulkReplyBtn').disabled = count === 0;
  document.getElementById('exportBtn').disabled = count === 0;
}

// Export selected emails' Order IDs and AWBs to CSV
async function exportSelected() {
  if (selectedEmails.size === 0) {
    showToast('No emails selected', 'warning');
    return;
  }

  const btn = document.getElementById('exportBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Exporting...';

  try {
    const messageIds = Array.from(selectedEmails);

    const res = await fetch('/mail-manager/export-selected', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messageIds })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Export failed');
    }

    // Download the CSV
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'selected_emails_export.csv';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    a.remove();

    showToast('Exported ' + messageIds.length + ' emails', 'success');
  } catch (err) {
    showToast('Export failed: ' + err.message, 'danger');
  } finally {
    btn.disabled = selectedEmails.size === 0;
    btn.innerHTML = '<i class="bi bi-download me-1"></i>Export';
  }
}

function startBulkReply() {
  if (selectedEmails.size === 0) {
    showToast('No emails selected', 'warning');
    return;
  }

  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('bulkReplyModal'));
  modal.show();

  // Reset stats
  document.getElementById('bulkProgressBar').style.width = '0%';
  document.getElementById('bulkProgressText').textContent = '0 / ' + selectedEmails.size;
  document.getElementById('bulkStatSuccess').textContent = '0';
  document.getElementById('bulkStatNoOrderId').textContent = '0';
  document.getElementById('bulkStatNoMapping').textContent = '0';
  document.getElementById('bulkStatNoVideo').textContent = '0';
  document.getElementById('bulkStatFailed').textContent = '0';
  document.getElementById('bulkStatSkipped').textContent = '0';
  document.getElementById('bulkReplyLog').innerHTML = '<div class="text-muted">Starting bulk reply...</div>';
  document.getElementById('bulkCancelBtn').classList.remove('d-none');
  document.getElementById('bulkDoneBtn').classList.add('d-none');

  // Start SSE connection
  const messageIds = Array.from(selectedEmails).join(',');
  bulkEventSource = new EventSource('/mail-manager/bulk-reply-stream?messageIds=' + encodeURIComponent(messageIds));

  const logDiv = document.getElementById('bulkReplyLog');

  bulkEventSource.addEventListener('start', (e) => {
    const data = JSON.parse(e.data);
    let statusMsg = `Processing ${data.toProcess} emails`;
    if (data.alreadyReplied > 0) statusMsg += ` (${data.alreadyReplied} already replied)`;
    if (data.hasMappingLoaded) {
      statusMsg += ` | Mapping: ${data.mappingCount} entries`;
    } else {
      statusMsg += ` | <span class="text-warning">No mapping loaded!</span>`;
    }
    logDiv.innerHTML = `<div>${statusMsg}</div>`;
    document.getElementById('bulkStatSkipped').textContent = data.alreadyReplied;
  });

  bulkEventSource.addEventListener('progress', (e) => {
    const data = JSON.parse(e.data);
    document.getElementById('bulkProgressBar').style.width = data.percent + '%';
    document.getElementById('bulkProgressText').textContent = data.current + ' / ' + data.total;
  });

  bulkEventSource.addEventListener('replied', (e) => {
    const data = JSON.parse(e.data);
    const successCount = parseInt(document.getElementById('bulkStatSuccess').textContent) + 1;
    document.getElementById('bulkStatSuccess').textContent = successCount;
    logDiv.innerHTML += `<div class="text-success"><i class="bi bi-check-circle me-1"></i>${escapeHtml(data.orderId || '')} â†’ ${escapeHtml(data.awb)} - Replied</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  });

  bulkEventSource.addEventListener('failed', (e) => {
    const data = JSON.parse(e.data);
    const failedCount = parseInt(document.getElementById('bulkStatFailed').textContent) + 1;
    document.getElementById('bulkStatFailed').textContent = failedCount;
    logDiv.innerHTML += `<div class="text-danger"><i class="bi bi-x-circle me-1"></i>Failed: ${escapeHtml(data.error || 'Unknown error')}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  });

  bulkEventSource.addEventListener('complete', (e) => {
    const data = JSON.parse(e.data);
    bulkEventSource.close();
    bulkEventSource = null;

    document.getElementById('bulkProgressBar').style.width = '100%';
    document.getElementById('bulkStatSuccess').textContent = data.success;
    document.getElementById('bulkStatNoOrderId').textContent = data.noOrderId || 0;
    document.getElementById('bulkStatNoMapping').textContent = data.noMapping || 0;
    document.getElementById('bulkStatNoVideo').textContent = data.noVideo;
    document.getElementById('bulkStatFailed').textContent = data.failed;
    document.getElementById('bulkStatSkipped').textContent = data.skipped;

    let summary = `Complete: ${data.success} replied`;
    if (data.noOrderId > 0) summary += `, ${data.noOrderId} no order ID`;
    if (data.noMapping > 0) summary += `, ${data.noMapping} no AWB mapping`;
    if (data.noVideo > 0) summary += `, ${data.noVideo} no video`;
    if (data.failed > 0) summary += `, ${data.failed} failed`;
    if (data.skipped > 0) summary += `, ${data.skipped} skipped`;

    logDiv.innerHTML += `<div class="fw-bold mt-2 pt-2 border-top">${summary}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;

    document.getElementById('bulkCancelBtn').classList.add('d-none');
    document.getElementById('bulkDoneBtn').classList.remove('d-none');

    // Refresh email list to show updated statuses
    searchEmails();
  });

  bulkEventSource.addEventListener('error', (e) => {
    let errMsg = 'Connection error';
    try {
      const data = JSON.parse(e.data);
      errMsg = data.message || errMsg;
    } catch {}
    logDiv.innerHTML += `<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Error: ${escapeHtml(errMsg)}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  });

  bulkEventSource.onerror = () => {
    if (bulkEventSource) {
      bulkEventSource.close();
      bulkEventSource = null;
      logDiv.innerHTML += `<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Connection lost</div>`;
      document.getElementById('bulkCancelBtn').classList.add('d-none');
      document.getElementById('bulkDoneBtn').classList.remove('d-none');
    }
  };
}

function cancelBulkReply() {
  if (bulkEventSource) {
    bulkEventSource.close();
    bulkEventSource = null;
    document.getElementById('bulkReplyLog').innerHTML += '<div class="text-warning"><i class="bi bi-x-circle me-1"></i>Cancelled by user</div>';
    document.getElementById('bulkCancelBtn').classList.add('d-none');
    document.getElementById('bulkDoneBtn').classList.remove('d-none');
  }
}

function closeBulkModal() {
  const modalEl = document.getElementById('bulkReplyModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  if (modal) modal.hide();
  clearSelection();
}
</script>
</body>
</html>
