<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kotty Operator Dashboard – Enhanced Overview</title>

  <!-- Primary viewport meta tag for responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0">

  <!-- Additional Mobile Web App / Theming Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d6efd">
  <meta name="msapplication-navbutton-color" content="#0d6efd">

  <!-- Google Font: Poppins -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" id="themeCSS">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #6c757d;
      --background-color: #f8f9fa;
      --text-color: #343a40;
      --nav-bg: #212529;
      --nav-text: #f8f9fa;
      --nav-border: #141618;
      --card-bg: #ffffff;
      --panel-border: #ddd;
      --hover-bg: #fafafa;
      --table-head-bg: #f2f2f2;
      --stat-gradient-start: #ffffff;
      --stat-gradient-end: #f1f1f1;
    }

    .dark-mode {
      --primary-color: #0d6efd;
      --secondary-color: #a1a7b3;
      --background-color: #1c1f22;
      --text-color: #e9ecef;
      --nav-bg: #0e0f10;
      --nav-text: #e9ecef;
      --nav-border: #2c2f33;
      --card-bg: #272a2e;
      --panel-border: #33373b;
      --hover-bg: #2e3237;
      --table-head-bg: #2c2f33;
      --stat-gradient-start: #33373b;
      --stat-gradient-end: #272a2e;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding-bottom: 3rem;
      padding-top: 70px; /* offset for fixed navbar */
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    * {
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .top-nav {
      background-color: var(--nav-bg);
      border-bottom: 3px solid var(--nav-border);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1030;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .top-nav .nav-brand {
      font-size: 1.7rem;
      font-weight: 600;
      color: var(--nav-text) !important;
    }
    .top-nav .nav-link {
      color: var(--nav-text) !important;
      font-size: 1rem;
      margin-right: 12px;
      transition: color 0.2s ease;
    }
    .top-nav .nav-link:hover {
      color: #ced4da !important;
    }
    .top-nav .navbar-toggler {
      border-color: rgba(248, 249, 250, 0.3);
    }
    .top-nav .navbar-toggler-icon {
      filter: invert(1);
    }
    .dark-mode-toggle {
      margin-right: 15px;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--nav-text) !important;
    }

    .portal-header {
      text-align: center;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }
    .portal-header h1 {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text-color);
    }
    .portal-header p {
      font-size: 1rem;
      color: var(--secondary-color);
    }

    .stat-box {
      background: linear-gradient(135deg, var(--stat-gradient-start), var(--stat-gradient-end));
      border: none;
      border-radius: 8px;
      text-align: center;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.3s;
      color: var(--text-color);
    }
    .stat-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.12);
    }
    .stat-box .stat-title {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.3rem;
      color: var(--secondary-color);
    }
    .stat-box .stat-value {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .data-panel {
      background-color: var(--card-bg);
      border: 1px solid var(--panel-border);
      border-radius: 4px;
      margin-bottom: 2rem;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .data-panel .panel-header {
      padding: 0.75rem 1rem;
      background-color: var(--background-color);
      border-bottom: 1px solid var(--panel-border);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .data-panel .panel-body {
      padding: 1rem;
    }
    .data-panel .panel-body table thead tr {
      background-color: var(--table-head-bg);
    }
    .data-panel .panel-body table tbody tr:hover {
      background-color: var(--hover-bg);
    }

    .nav-tabs .nav-link {
      color: var(--text-color);
      font-weight: 500;
      border: 1px solid transparent;
      border-radius: 0;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    }
    .nav-tabs .nav-link.active {
      background-color: var(--card-bg);
      color: var(--primary-color);
      border-bottom: none;
      border-right: 1px solid var(--panel-border);
      border-left: 1px solid var(--panel-border);
      border-top: 1px solid var(--panel-border);
    }
    .tab-content .tab-pane {
      margin-top: 1.5rem;
    }

    .leftover-value {
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
      font-weight: 600;
      margin-right: 5px;
    }
    .leftover-zero {
      background-color: #f8d7da; /* Light red */
      color: #721c24;
    }
    .leftover-nonzero {
      background-color: #cce5ff; /* Light blue */
      color: #004085;
    }
    .leftover-unassigned {
      color: #dc3545;
      font-weight: 700;
    }

    .modal-content {
      border-radius: 4px;
      border: 1px solid var(--panel-border);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    .modal-header {
      background-color: var(--background-color);
      border-bottom: 1px solid var(--panel-border);
    }
    .modal-header .modal-title {
      color: var(--text-color);
    }
    .modal-footer {
      border-top: 1px solid var(--panel-border);
    }
  </style>
</head>
<body>

  <!-- TOP NAV BAR -->
  <nav class="navbar navbar-expand-lg top-nav">
    <div class="container-fluid">
      <a class="navbar-brand nav-brand" href="#">
        <img src="https://cdn.staticans.com/image/catalog/brandstore/kotty/892-1720722600-favicon-2.png"
             alt="Brand Logo" width="30" height="30" class="d-inline-block align-text-top">
        Kotty
      </a>
      <!-- Dark Mode Toggle -->
      <i class="bi bi-moon-fill dark-mode-toggle" id="toggleDarkMode" 
         data-bs-toggle="tooltip" title="Toggle Dark/Light Mode"></i>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#mainNavigation"
              aria-controls="mainNavigation" aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNavigation">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/operator/dashboard/download-all-lots"
               data-bs-toggle="tooltip" title="Download Everything">
              <i class="bi bi-cloud-arrow-down"></i> Export All
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/operator/dashboard/leftovers/download"
               data-bs-toggle="tooltip" title="Leftover CSV Export">
              <i class="bi bi-file-earmark-arrow-down"></i> Leftover CSV
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/search-dashboard"
               data-bs-toggle="tooltip" title="Search Module">
              <i class="bi bi-search"></i> Search
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="window.print()"
               data-bs-toggle="tooltip" title="Print Page">
              <i class="bi bi-printer"></i> Print
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/assign-to-washing"
               data-bs-toggle="tooltip" title="Assign Washing">
              <i class="bi bi-arrow-right-circle"></i> Washing
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout"
               data-bs-toggle="tooltip" title="Sign Out">
              <i class="bi bi-box-arrow-left"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HEADER TITLE -->
  <div class="portal-header">
    <h1>Kotty Operator Dashboard</h1>
    <p class="text-muted">Enhanced Production &amp; Leftover Overview</p>
  </div>

  <!-- STAT CARDS -->
  <div class="container mb-4">
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center">
      <div class="col">
        <div class="stat-box">
          <div class="stat-title">Total Kits</div>
          <div class="stat-value"><%= lotCount %></div>
        </div>
      </div>
      <div class="col">
        <div class="stat-box">
          <div class="stat-title">Cut Pieces</div>
          <div class="stat-value"><%= totalPiecesCut %></div>
        </div>
      </div>
      <div class="col">
        <div class="stat-box">
          <div class="stat-title">Finished</div>
          <div class="stat-value"><%= totalFinished %></div>
        </div>
      </div>
      <div class="col">
        <div class="stat-box">
          <div class="stat-title">Active Users</div>
          <div class="stat-value"><%= userCount %></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- SKU PERFORMANCE -->
    <div class="data-panel mb-4">
      <div class="panel-header">
        <i class="bi bi-bar-chart-line"></i> SKU Insights
      </div>
      <div class="panel-body">
        <div class="row g-4">
          <div class="col-md-6">
            <h6><i class="bi bi-arrow-up-square"></i> Best 5 SKUs</h6>
            <table class="table table-striped table-bordered table-sm">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Pieces</th>
                  <th>% Cut Share</th>
                </tr>
              </thead>
              <tbody>
                <% advancedAnalytics.top5SKUs.forEach(item => {
                  let pct = advancedAnalytics.totalCut > 0
                            ? ((item.total / advancedAnalytics.totalCut) * 100).toFixed(2)
                            : '0.00';
                %>
                  <tr>
                    <td><%= item.sku %></td>
                    <td><%= item.total %></td>
                    <td><%= pct %>%</td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <h6><i class="bi bi-arrow-down-square"></i> Lowest 5 SKUs</h6>
            <table class="table table-striped table-bordered table-sm">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Pieces</th>
                  <th>% Cut Share</th>
                </tr>
              </thead>
              <tbody>
                <% advancedAnalytics.bottom5SKUs.forEach(item => {
                  let pct = advancedAnalytics.totalCut > 0
                            ? ((item.total / advancedAnalytics.totalCut) * 100).toFixed(2)
                            : '0.00';
                %>
                  <tr>
                    <td><%= item.sku %></td>
                    <td><%= item.total %></td>
                    <td><%= pct %>%</td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="leftover-tab" data-bs-toggle="tab"
                data-bs-target="#leftoverPanel" type="button" role="tab"
                aria-controls="leftoverPanel" aria-selected="true">
          <i class="bi bi-box-seam"></i> Leftovers
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="kitDetails-tab" data-bs-toggle="tab"
                data-bs-target="#kitDetailsPanel" type="button" role="tab"
                aria-controls="kitDetailsPanel" aria-selected="false">
          <i class="bi bi-card-list"></i> Kit Details
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="extraNotes-tab" data-bs-toggle="tab"
                data-bs-target="#notesPanel" type="button" role="tab"
                aria-controls="notesPanel" aria-selected="false">
          <i class="bi bi-chat-left-text"></i> Notes
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Leftover Tab -->
      <div class="tab-pane fade show active" id="leftoverPanel" role="tabpanel"
           aria-labelledby="leftover-tab">
        <div class="data-panel mt-3">
          <div class="panel-header">
            <i class="bi bi-box2"></i> All Leftover Items
          </div>
          <div class="panel-body">
            <div class="mb-3">
              <input type="text" id="filterLeftover" class="form-control"
                     placeholder="Filter leftover entries...">
            </div>
            <div class="table-responsive">
              <% 
                function formatLeftover(val, operator) {
                  if (typeof val === 'number') {
                    const leftoverClass = (val === 0)
                      ? 'leftover-zero'
                      : 'leftover-nonzero';
                    let leftoverHTML = `<span class="leftover-value ${leftoverClass}">${val}</span>`;
                    
                    let operatorHTML = '';
                    if (!operator || operator.toLowerCase() === 'n/a') {
                      operatorHTML = ` <small class="leftover-unassigned">(Unassigned)</small>`;
                    } else {
                      operatorHTML = ` <small class="text-muted">(User: ${operator})</small>`;
                    }
                    return leftoverHTML + operatorHTML;
                  }
                  return val;
                }
              %>
              <% if (Object.keys(lotDetails).length === 0) { %>
                <p class="text-muted">No data found.</p>
              <% } else { %>
                <table id="leftoverTable" class="table table-striped table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Kit #</th>
                      <th>Total Pieces</th> <!-- Updated header -->
                      <th>Stitch Leftover</th>
                      <th>Wash Leftover</th>
                      <th>Finish Leftover</th>
                      <th>Assembly Leftover</th>
                      <th>Remarks</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% Object.keys(lotDetails).forEach(kitNumber => {
                         const kit = lotDetails[kitNumber];
                         // Use total_pieces from cutting_lots instead of the owner name
                         const totalPieces = kit.cuttingLot ? kit.cuttingLot.total_pieces : 'N/A';
                         const leftoverStitch = formatLeftover(kit.leftovers.leftoverStitch, kit.stitchingAssignedUser);
                         const leftoverWash   = formatLeftover(kit.leftovers.leftoverWash, kit.washingAssignedUser);
                         const leftoverFinish = formatLeftover(kit.leftovers.leftoverFinish, kit.finishingAssignedUser);
                         const leftoverJeans  = formatLeftover(kit.leftovers.leftoverJeans, kit.jeansAssemblyAssignedUser);
                         const remark = kit.cuttingLot ? (kit.cuttingLot.remark || 'None') : 'None';
                    %>
                      <tr>
                        <td><%= kitNumber %></td>
                        <td><%= totalPieces %></td>
                        <td><%- leftoverStitch %></td>
                        <td><%- leftoverWash %></td>
                        <td><%- leftoverFinish %></td>
                        <td><%- leftoverJeans %></td>
                        <td><%= remark %></td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Kit Details Tab -->
      <div class="tab-pane fade" id="kitDetailsPanel" role="tabpanel"
           aria-labelledby="kitDetails-tab">
        <div class="accordion mt-3" id="kitsAccordion">
          <% Object.keys(lotDetails).forEach((kitNumber, idx) => {
               const kit = lotDetails[kitNumber];
               const cLot = kit.cuttingLot;
               const kitRemark = cLot ? (cLot.remark || 'None') : 'None';
          %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="acc-heading-<%= idx %>">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#acc-collapse-<%= idx %>"
                      aria-expanded="false"
                      aria-controls="acc-collapse-<%= idx %>">
                Kit <%= kitNumber %> | SKU: <%= cLot ? cLot.sku : 'N/A' %> 
                | Status: <%= kit.status %> 
                | Remarks: <%= kitRemark %>
              </button>
            </h2>
            <div id="acc-collapse-<%= idx %>" class="accordion-collapse collapse"
                 aria-labelledby="acc-heading-<%= idx %>"
                 data-bs-parent="#kitsAccordion">
              <div class="accordion-body">
                <div class="row g-4">
                  <div class="col-md-4">
                    <p><strong>Creator:</strong> <%= cLot ? cLot.created_by : 'N/A' %></p>
                    <p><strong>Total Pieces:</strong> <%= cLot ? cLot.total_pieces : 0 %></p>
                    <p><strong>Remarks:</strong> <%= kitRemark %></p>
                  </div>
                  <div class="col-md-4">
                    <p><strong>Remaining Steps:</strong></p>
                    <ul class="list-unstyled">
                      <li>Stitch: <%= kit.leftovers.leftoverStitch %></li>
                      <li>Wash: <%= kit.leftovers.leftoverWash %></li>
                      <li>Finish: <%= kit.leftovers.leftoverFinish %></li>
                      <li>Assembly: <%= kit.leftovers.leftoverJeans %></li>
                    </ul>
                  </div>
                  <div class="col-md-4">
                    <p><strong>Assigned Operators:</strong></p>
                    <ul class="list-unstyled">
                      <li>Stitching: <%= kit.stitchingAssignedUser %></li>
                      <li>Washing: <%= kit.washingAssignedUser %></li>
                      <li>Finishing: <%= kit.finishingAssignedUser %></li>
                      <li>Jeans: <%= kit.jeansAssemblyAssignedUser %></li>
                    </ul>
                    <button class="btn btn-sm btn-warning"
                            data-bs-toggle="modal"
                            data-bs-target="#editModal-<%= kitNumber %>">
                      <i class="bi bi-pencil-square"></i> Modify
                    </button>
                    <a class="btn btn-sm btn-success ms-2"
                       href="/operator/dashboard/lot-tracking/<%= kitNumber %>/download"
                       target="_blank">
                      <i class="bi bi-arrow-bar-down"></i> CSV
                    </a>
                  </div>
                </div>
                <hr>
                <div class="row g-4">
                  <div class="col-md-6">
                    <h6>Cut Sizes</h6>
                    <% if (kit.cuttingSizes && kit.cuttingSizes.length) { %>
                    <table class="table table-sm table-bordered table-striped">
                      <thead>
                        <tr>
                          <th>Size</th>
                          <th>Pattern</th>
                          <th>Pieces</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% kit.cuttingSizes.forEach(sz => { %>
                        <tr>
                          <td><%= sz.size_label %></td>
                          <td><%= sz.pattern_count %></td>
                          <td><%= sz.total_pieces %></td>
                        </tr>
                        <% }); %>
                      </tbody>
                    </table>
                    <% } else { %>
                    <p class="text-muted">No size info available.</p>
                    <% } %>
                  </div>
                  <div class="col-md-6">
                    <h6>Roll Details</h6>
                    <% if (kit.cuttingRolls && kit.cuttingRolls.length) { %>
                    <table class="table table-sm table-bordered table-striped">
                      <thead>
                        <tr>
                          <th>Roll #</th>
                          <th>Weight</th>
                          <th>Layers</th>
                          <th>Pieces</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% kit.cuttingRolls.forEach(r => { %>
                        <tr>
                          <td><%= r.roll_no %></td>
                          <td><%= r.weight_used %></td>
                          <td><%= r.layers %></td>
                          <td><%= r.total_pieces %></td>
                        </tr>
                        <% }); %>
                      </tbody>
                    </table>
                    <% } else { %>
                    <p class="text-muted">No roll info available.</p>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <% }); %>
        </div>
        <!-- Pagination for Kit Details Accordion -->
        <div id="kitDetailsPaginationContainer"></div>
      </div>

      <!-- Notes Tab -->
      <div class="tab-pane fade" id="notesPanel" role="tabpanel"
           aria-labelledby="extraNotes-tab">
        <div class="data-panel mt-3">
          <div class="panel-header">
            <i class="bi bi-chat-left-text"></i> Dashboard Notes
          </div>
          <div class="panel-body">
            <ul>
              <li><strong>Leftovers Tab:</strong> Highlights leftover counts. A red highlight means 0; a blue highlight means a non-zero leftover. “(Unassigned)” appears if no operator is assigned.</li>
              <li><strong>Kit Details:</strong> Expand each kit to see sizes, rolls, assigned operators, etc. Click <em>Modify</em> to edit.</li>
              <li><strong>SKU Insights:</strong> Ranks the top and bottom SKUs by cut share.</li>
              <li><strong>Advanced Stats:</strong> Displays conversions, turnaround, and pending kit info.</li>
              <li><strong>Export Options:</strong> Download CSVs (all or leftover-only) from the top navigation.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ADVANCED ANALYTICS -->
    <div class="data-panel mt-4">
      <div class="panel-header">
        <i class="bi bi-graph-up-arrow"></i> Advanced Stats
      </div>
      <div class="panel-body">
        <div class="row g-3">
          <div class="col-md-3">
            <p><strong>Stitch Conversion:</strong> <%= advancedAnalytics.stitchConversion %>%</p>
          </div>
          <div class="col-md-3">
            <p><strong>Wash Conversion:</strong> <%= advancedAnalytics.washConversion %>%</p>
          </div>
          <div class="col-md-3">
            <p><strong>Finish Conversion:</strong> <%= advancedAnalytics.finishConversion %>%</p>
          </div>
          <div class="col-md-3">
            <p><strong>Avg Turnaround (days):</strong> <%= advancedAnalytics.avgTurnaroundTime %></p>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-3">
            <p><strong>Pending Kits:</strong> <%= advancedAnalytics.pendingLots %></p>
          </div>
          <div class="col-md-3">
            <p><strong>Total Kits:</strong> <%= advancedAnalytics.totalLots %></p>
          </div>
          <div class="col-md-3">
            <p><strong>Stitch Approval:</strong> <%= advancedAnalytics.stitchApprovalRate %>%</p>
          </div>
          <div class="col-md-3">
            <p><strong>Wash Approval:</strong> <%= advancedAnalytics.washApprovalRate %>%</p>
          </div>
        </div>
      </div>
    </div>

    <!-- OPERATOR PERFORMANCE -->
    <div class="data-panel mt-4">
      <div class="panel-header">
        <i class="bi bi-people"></i> Operator Tracking
      </div>
      <div class="panel-body table-responsive">
        <table class="table table-striped table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Stitched</th>
              <th>Washed</th>
              <th>Finished</th>
            </tr>
          </thead>
          <tbody>
            <% for (let uid in operatorPerformance) {
                 let opObj = operatorPerformance[uid];
            %>
              <tr>
                <td><%= uid %></td>
                <td><%= opObj.username %></td>
                <td><%= opObj.totalStitched %></td>
                <td><%= opObj.totalWashed %></td>
                <td><%= opObj.totalFinished %></td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- EDIT KIT MODALS -->
  <% Object.keys(lotDetails).forEach(kitNumber => {
       const kitData = lotDetails[kitNumber];
       const cLot = kitData.cuttingLot;
       const totalPieces = cLot ? cLot.total_pieces : 0;
       const existingRemark = cLot ? (cLot.remark || '') : '';
  %>
  <div class="modal fade" id="editModal-<%= kitNumber %>" tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="/operator/dashboard/edit-lot">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square"></i> Update Kit <%= kitNumber %>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="lot_no" value="<%= kitNumber %>">
            <div class="mb-3">
              <label class="form-label">Pieces Count</label>
              <input type="number" class="form-control" name="total_pieces"
                     value="<%= totalPieces %>" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Remarks</label>
              <textarea class="form-control" name="remark" rows="3"><%= existingRemark %></textarea>
            </div>
            <small class="text-muted">
              Override the number of pieces or adjust remarks as necessary.
            </small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check2-circle"></i> Save
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <% }); %>

  <!-- JS & DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
  <script>
    // Tooltips
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
    });

    // DataTable for the Leftover table with pagination enabled
    $(document).ready(function() {
      const leftoverDT = $('#leftoverTable').DataTable({
        responsive: true,
        paging: true,          // Enable pagination
        pageLength: 10,        // Change this value as needed
        info: true,
        language: { search: "Filter Leftovers:" }
      });
      $('#filterLeftover').on('keyup', function() {
        leftoverDT.search(this.value).draw();
      });

      // Autofocus the first input when any modal is shown
      $('.modal').on('shown.bs.modal', function () {
        $(this).find('input:first').trigger('focus');
      });

      // Pagination for Kit Details Accordion
      var itemsPerPage = 5; // Adjust number of kits per page as needed
      var kitItems = $("#kitsAccordion .accordion-item");
      var totalItems = kitItems.length;
      var totalPages = Math.ceil(totalItems / itemsPerPage);

      if(totalPages > 1) {
        // Create pagination container
        var paginationHTML = '<nav><ul class="pagination justify-content-center" id="kitPagination"></ul></nav>';
        $("#kitDetailsPaginationContainer").html(paginationHTML);
        for(var i = 1; i <= totalPages; i++){
          $("#kitPagination").append('<li class="page-item"><a class="page-link" href="#">' + i + '</a></li>');
        }
        
        // Function to show the current page and hide the others
        function showPage(page) {
          kitItems.hide();
          kitItems.slice((page - 1) * itemsPerPage, page * itemsPerPage).show();
          $("#kitPagination li").removeClass("active");
          $("#kitPagination li").eq(page - 1).addClass("active");
        }
        
        // Set up click events on the pagination links
        $("#kitPagination li a").on("click", function(e) {
          e.preventDefault();
          var page = parseInt($(this).text());
          showPage(page);
        });
        
        // Show the first page initially
        showPage(1);
      }
    });

    // Dark Mode Toggle
    const body = document.body;
    const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
    const darkModePreference = localStorage.getItem('kottyDarkMode') === 'true';
    if (darkModePreference) {
      body.classList.add('dark-mode');
    }
    toggleDarkModeBtn.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      localStorage.setItem('kottyDarkMode', body.classList.contains('dark-mode'));
    });
  </script>
</body>
</html>
