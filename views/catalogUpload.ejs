<!-- views/catalogUpload.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>File Upload & Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    body { background:#f4f6f9; font-family:"Segoe UI", Roboto, Arial; }
    .wrapper { max-width:900px; margin:2rem auto; padding:0 1rem; }
    .card { border:none; border-radius:1rem; box-shadow:0 0 24px rgba(0,0,0,.05); margin-bottom:2rem; }
    .card-header { background:#fff; border-bottom:1px solid #e3e6f0; padding:1rem 1.5rem; font-weight:600; }
    .card-body { padding:1.5rem; }
    .btn { padding:.6rem 1.5rem; transition:.1s, .2s; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px)} to {opacity:1;transform:translateY(0)} }
  </style>
</head>
<body>
  <div class="wrapper">

    <!-- Title -->
    <div class="text-center mb-5">
      <h1 class="display-6 fw-bold">üìÅ Upload & Search Catalog</h1>
      <p class="text-muted fs-5">Your files, at a glance</p>
    </div>

    <!-- Flash Messages -->
    <% const msgs = (arr, type) => arr.map(m=>`
      <div class="alert alert-${type} alert-dismissible d-flex align-items-center" role="alert">
        <i class="bi bi-${type==='success'?'check-circle-fill':'exclamation-triangle-fill'} fs-4 me-2"></i>
        <div>${m}</div>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
      </div>
    `).join('');
       const sarr = Array.isArray(success)? success : (success? [success]:[]);
       const earr = Array.isArray(error  )? error   : (error  ? [error]  :[]);
    %>
    <%- msgs(sarr,'success') %>
    <%- msgs(earr,'danger')  %>

    <!-- Upload Card -->
    <div class="card" style="animation:fadeIn .4s">
      <div class="card-header text-primary"><i class="bi bi-upload me-1"></i> Upload File</div>
      <div class="card-body">
        <form action="/catalogUpload/upload" method="POST" enctype="multipart/form-data">
          <div class="row g-4">
            <div class="col-md-6">
              <label class="form-label">Marketplace</label>
              <select name="marketplace" class="form-select" required>
                <option value="">Select‚Ä¶</option>
                <% markets.forEach(m=>{ %>
                  <option value="<%= m.id %>" <%= selectedMarketplace==m.id?'selected':'' %>>
                    <%= m.name %>
                  </option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">File</label>
              <input type="file" name="csvfile" class="form-control" accept=".csv,.xls,.xlsx" required>
            </div>
          </div>
          <div class="text-end mt-4">
            <button class="btn btn-primary">
              <i class="bi bi-cloud-arrow-up me-1"></i> Upload
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Search Card -->
    <div class="card" style="animation:fadeIn .4s">
      <div class="card-header text-success"><i class="bi bi-search me-1"></i> Search Files</div>
      <div class="card-body">
        <form action="/catalogUpload/search" method="GET">
          <div class="row g-4">
            <div class="col-md-4">
              <label class="form-label">Marketplace</label>
              <select name="marketplace" class="form-select" required>
                <option value="">Select‚Ä¶</option>
                <% markets.forEach(m=>{ %>
                  <option value="<%= m.id %>" <%= selectedMarketplace==m.id?'selected':'' %>>
                    <%= m.name %>
                  </option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Term</label>
              <input type="text" name="q" class="form-control" placeholder="Keyword‚Ä¶" value="<%= q %>" required>
            </div>
          </div>
          <div class="text-end mt-4">
            <button class="btn btn-success">
              <i class="bi bi-search me-1"></i> Search
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- All Files Card -->
    <div class="card" style="animation:fadeIn .4s">
      <div class="card-header text-dark"><i class="bi bi-list-ul me-1"></i> All Uploads</div>
      <div class="card-body">
        <ul class="list-group" id="file-list">
          <% let lastDate = null; %>
          <% files.forEach(f => {
               const ds = new Date(f.uploaded_at).toLocaleDateString();
               if (ds !== lastDate) { %>
            <li class="list-group-item list-group-item-secondary">
              <strong><%= ds %></strong>
            </li>
          <%   lastDate = ds;
               } %>
          <li class="list-group-item d-flex justify-content-between">
            <%= f.original_filename %>
            <a href="/catalogUpload/download/<%= f.id %>" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-download"></i>
            </a>
          </li>
          <% }) %>
        </ul>
        <div id="files-sentinel" class="text-center my-3 text-muted">Loading more‚Ä¶</div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Lazy-load next batches
    (function(){
      let offset = <%= initialLimit %>;
      const limit = <%= initialLimit %>;
      const market = '<%= selectedMarketplace||'' %>';
      let loading = false;

      const listEl   = document.getElementById('file-list');
      const sentinel = document.getElementById('files-sentinel');

      const append = files => {
        files.forEach(f => {
          const d  = new Date(f.uploaded_at).toLocaleDateString();
          const lastHeader = listEl.lastElementChild?.dataset?.date;
          if (d !== lastHeader) {
            const hdr = document.createElement('li');
            hdr.className = 'list-group-item list-group-item-secondary';
            hdr.innerHTML = '<strong>' + d + '</strong>';
            hdr.dataset.date = d;
            listEl.appendChild(hdr);
          }
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between';
          li.innerHTML = `
            ${f.original_filename}
            <a href="/catalogUpload/download/${f.id}" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-download"></i>
            </a>
          `;
          listEl.appendChild(li);
        });
      };

      const obs = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting && !loading) {
          loading = true;
          fetch(`/catalogUpload/files?offset=${offset}&limit=${limit}&marketplace=${market}`)
            .then(r => r.json())
            .then(data => {
              if (data.files.length) {
                append(data.files);
                offset += data.files.length;
                loading = data.files.length === limit;
              }
              if (!loading) obs.disconnect();
            })
            .catch(()=> obs.disconnect());
        }
      }, { rootMargin: '200px' });

      obs.observe(sentinel);
    })();
  </script>
</body>
</html>
