<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventory Stock Market</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --color-bg-primary: #f7f9fb;
      --color-surface: #ffffff;
      --color-border: #dce4ed;
      --color-text-primary: #1b2838;
      --color-text-secondary: #4b5563;
      --color-text-muted: #6b7280;
      --color-accent: #0f52ba;
      --color-accent-soft: #e9f0ff;
      --color-danger: #d60036;
      --color-danger-soft: #ffe5ec;
      --color-warning: #7c3aed;
      --color-warning-soft: #f1e9ff;
      --color-success: #0f9d58;
      --shadow-md: 0 14px 24px rgba(15, 82, 186, 0.06);
      --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    body {
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 18px;
      line-height: 1.65;
    }

    .navbar {
      background: var(--color-surface) !important;
      border-bottom: 1px solid var(--color-border);
      box-shadow: var(--shadow-soft);
      padding: 1rem 0;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.4rem;
      letter-spacing: -0.01em;
      color: var(--color-text-primary) !important;
    }

    .navbar-brand i {
      color: var(--color-accent);
    }

    .page-lede {
      background: linear-gradient(135deg, rgba(15, 82, 186, 0.08), rgba(15, 82, 186, 0.02));
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: 1.5rem 1.75rem;
      box-shadow: var(--shadow-soft);
    }

    .card {
      border: 1px solid var(--color-border);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
    }

    .card-body {
      padding: 1.75rem;
    }

    .nav-pills {
      gap: 0.5rem;
      padding: 0.35rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      box-shadow: var(--shadow-soft);
    }

    .nav-actions { flex-wrap: wrap; }

    .search-group {
      width: 100%;
      max-width: 420px;
    }

    .nav-pills .nav-link {
      color: var(--color-text-secondary);
      border-radius: 10px;
      padding: 0.8rem 1.4rem;
      font-size: 1.05rem;
      font-weight: 600;
      border: 1px solid transparent;
    }

    .nav-pills .nav-link.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: #fff;
      box-shadow: 0 10px 18px rgba(15, 82, 186, 0.25);
    }

    .status-pill {
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 1.05rem;
      letter-spacing: 0.01em;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      border: 1px solid transparent;
      text-transform: uppercase;
    }

    .status-pill::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 0 6px rgba(0, 0, 0, 0.04);
    }

    .status-red {
      background: var(--color-danger-soft);
      color: var(--color-danger);
      border-color: rgba(214, 0, 54, 0.32);
      box-shadow: 0 0 0 2px rgba(214, 0, 54, 0.14);
    }

    .status-purple {
      background: var(--color-warning-soft);
      color: var(--color-warning);
      border-color: rgba(124, 58, 237, 0.28);
    }

    .status-green {
      background: #e8f5ef;
      color: var(--color-success);
      border-color: rgba(15, 157, 88, 0.28);
    }

    .table { color: var(--color-text-primary); font-size: 1.05rem; }

    .table thead th {
      background: #f0f4f9;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 1rem;
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table tbody tr.row-critical {
      background: linear-gradient(90deg, rgba(214, 0, 54, 0.08), rgba(214, 0, 54, 0.02));
    }

    .table tbody tr.row-warning {
      background: linear-gradient(90deg, rgba(124, 58, 237, 0.05), rgba(124, 58, 237, 0.01));
    }

    .table tbody td {
      padding: 1rem 0.85rem;
      vertical-align: middle;
    }

    .search-input {
      border: 1px solid var(--color-border);
      border-radius: 10px;
      padding: 0.9rem 1.1rem;
      font-size: 1.05rem;
    }

    .input-group-text {
      border-color: var(--color-border);
      background: var(--color-accent-soft);
      color: var(--color-accent);
      border-radius: 10px 0 0 10px !important;
    }

    h3 { font-weight: 800; letter-spacing: -0.02em; font-size: 2rem; }
    .text-faint { color: var(--color-text-muted); }
    .metric-label { color: var(--color-text-secondary); font-weight: 700; font-size: 1.05rem; }

    .legend-pills { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }

    .alert-note {
      color: var(--color-danger);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .stat-card {
      border-radius: 14px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      box-shadow: var(--shadow-md);
      padding: 1.25rem 1.5rem;
    }

    .stat-label { color: var(--color-text-muted); font-weight: 700; font-size: 1.1rem; }
    .stat-value { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.02em; }
    .stat-subtle { color: var(--color-text-secondary); font-weight: 700; font-size: 1.05rem; }

    .action-card {
      border: 1px dashed var(--color-border);
      border-radius: 14px;
      background: var(--color-accent-soft);
      color: var(--color-accent);
      box-shadow: var(--shadow-soft);
      padding: 1.25rem 1.5rem;
      height: 100%;
      font-size: 1.05rem;
    }

    .action-card:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      text-decoration: none;
      box-shadow: 0 10px 18px rgba(15, 82, 186, 0.14);
    }

    .stack-table { width: 100%; }

    @media (max-width: 1200px) {
      .page-lede .lede-wrap {
        flex-direction: column;
        align-items: flex-start;
      }
      .page-lede .lede-actions {
        width: 100%;
        justify-content: flex-start;
      }
      .legend-pills {
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .card-body { padding: 1.25rem; }
      h3 { font-size: 1.5rem; }
      body { font-size: 17px; }
      .navbar { padding: 0.85rem 0; }
      .nav-actions { width: 100%; justify-content: space-between; }
      .nav-actions .btn { flex: 1; justify-content: center; }
      .page-lede { padding: 1.25rem; }
      .nav-pills { width: 100%; }
      .nav-pills .nav-link { width: 100%; text-align: center; }
      .card-body.d-flex { flex-direction: column; align-items: flex-start !important; }
      .search-group { width: 100%; max-width: none; }
      .legend-pills { width: 100%; }
    }

    @media (max-width: 992px) {
      .table-responsive { overflow: visible; }
      .table.stack-table { display: block; }
      .table.stack-table thead { display: none; }
      .table.stack-table tbody { display: block; }
      .table.stack-table tbody tr {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.35rem 0.75rem;
        padding: 1rem 1rem 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: var(--color-surface);
        box-shadow: var(--shadow-soft);
      }
      .table.stack-table tbody td {
        padding: 0.35rem 0;
        text-align: left !important;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .table.stack-table tbody td::before {
        content: attr(data-label);
        font-weight: 700;
        color: var(--color-text-secondary);
        margin-right: 0.75rem;
        flex: 1;
        max-width: 160px;
      }
      .table.stack-table tbody td:last-child { grid-column: 1 / -1; }
      .table.stack-table tbody tr.row-critical,
      .table.stack-table tbody tr.row-warning { background-image: none; }
    }

    @media print {
      body { background: #fff; }
      .navbar, .page-lede, .nav, .input-group { display: none !important; }
      .status-pill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .table tbody tr { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/professional.css">
</head>
<body>
<% const isMohitOperator = (user?.username || '').toLowerCase() === 'mohitoperator'; %>
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <span class="navbar-brand">
      <i class="bi bi-graph-up-arrow me-2"></i>Stock Market View
    </span>
    <div class="ms-auto d-flex align-items-center gap-3 nav-actions">
      <% if (user) { %>
        <span class="text-secondary small">
          Hi, <strong><%= user.username || user.name %></strong>
        </span>
      <% } %>
      <a href="/logout" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-box-arrow-right me-1"></i>Logout
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">
      <div class="page-lede mb-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 lede-wrap">
      <div class="flex-grow-1">
        <h3 class="fw-bold mb-2">Inventory runway & order momentum</h3>
        <p class="text-faint mb-0">
          A calm, light view for fast decisions. Red rows mean critical stockout risk; purple rows mark SKUs on watch.
        </p>
        <div class="alert-note mt-2">
          <i class="bi bi-exclamation-triangle-fill"></i>
          Critical red items need immediate action.
        </div>
      </div>
        <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end lede-actions">
        <% if (isMohitOperator) { %>
          <a class="btn btn-outline-primary d-flex align-items-center gap-2" href="/easyecom/stock-market/making-time">
            <i class="bi bi-upload"></i><span>Bulk making time</span>
          </a>
        <% } %>
        <button class="btn btn-success d-flex align-items-center gap-2" id="download-excel" type="button">
          <i class="bi bi-file-earmark-excel"></i><span>Download Excel</span>
        </button>
        <label class="text-faint fw-semibold" for="period-select">Period</label>
        <select class="form-select" id="period-select" name="period">
          <% Object.entries(periodPresets).forEach(([key, preset]) => { %>
            <option value="<%= key %>" <%= key === periodKey ? 'selected' : '' %>>
              <%= preset.label %>
            </option>
          <% }); %>
        </select>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="inventory-tab" data-bs-toggle="pill" data-bs-target="#inventory" type="button" role="tab">
        <i class="bi bi-box-seam me-2"></i>Inventory
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button" role="tab">
        <i class="bi bi-cart-check me-2"></i>Orders
      </button>
    </li>
  </ul>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="stat-card">
        <div class="stat-label">Critical SKUs</div>
        <div class="stat-value" id="metric-critical">0</div>
        <div class="stat-subtle">Need replenishment now</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stat-card">
        <div class="stat-label">On watch</div>
        <div class="stat-value" id="metric-watch">0</div>
        <div class="stat-subtle">Monitor before they slip</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stat-card">
        <div class="stat-label">Avg. runway</div>
        <div class="stat-value" id="metric-runway">0d</div>
        <div class="stat-subtle">Median days left across SKUs</div>
      </div>
    </div>
  </div>

  <% if (isMohitOperator) { %>
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <a class="action-card d-flex align-items-center justify-content-between" href="/easyecom/stock-market/making-time">
          <div>
            <div class="fw-semibold">Bulk making time</div>
            <div class="small text-faint">Upload rows to refresh replenishment rules quickly.</div>
          </div>
          <i class="bi bi-arrow-up-right fs-4"></i>
        </a>
      </div>
      <div class="col-md-6">
        <div class="action-card">
          <div class="fw-semibold mb-1">Operator tips</div>
          <div class="small">Sort by warehouse or search SKUs to zero in on risk. Use the Orders tab to confirm demand before you raise POs.</div>
        </div>
      </div>
    </div>
  <% } %>

  <div class="tab-content" id="pills-tabContent">
    <div class="tab-pane fade show active" id="inventory" role="tabpanel">
      <div class="card mb-4">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
          <div class="legend-pills">
            <span class="status-pill status-red">Critical</span>
            <span class="status-pill status-purple">Watch</span>
            <span class="status-pill status-green">Healthy</span>
          </div>
          <div class="input-group search-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="search"
              id="inventory-search"
              class="form-control search-input"
              placeholder="Search SKU or warehouse..."
            >
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 stack-table" id="inventory-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Warehouse</th>
              <th class="text-end">Inventory</th>
              <th class="text-end">Making time (days)</th>
              <th class="text-end">Yesterday orders</th>
              <th class="text-end">Days left</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% inventory.forEach(item => { %>
              <% const infinite = !Number.isFinite(item.days_left); %>
              <tr data-filter="<%= `${item.sku} ${item.warehouse_id ?? ''}`.toLowerCase() %>" class="<%= item.status === 'red' ? 'row-critical' : item.status === 'purple' ? 'row-warning' : '' %>">
                <td data-label="SKU" class="fw-semibold"><%= item.sku %></td>
                <td data-label="Warehouse" class="text-faint"><%= item.warehouse_id ?? 'N/A' %></td>
                <td data-label="Inventory" class="text-end"><%= item.inventory.toLocaleString() %></td>
                <td data-label="Making time" class="text-end"><%= item.making_time_days %></td>
                <td data-label="Yesterday orders" class="text-end"><%= item.yesterday_orders %></td>
                <td data-label="Days left" class="text-end"><%= infinite ? '∞' : item.days_left.toFixed(1) %></td>
                <td data-label="Status">
                  <% if (item.status === 'red') { %>
                    <span class="status-pill status-red">Critical</span>
                  <% } else if (item.status === 'purple') { %>
                    <span class="status-pill status-purple">Watch</span>
                  <% } else { %>
                    <span class="status-pill status-green">Healthy</span>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="orders" role="tabpanel">
      <div class="card mb-4">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
          <div>
            <div class="metric-label">
              Orders ranked by volume for <strong id="orders-period-label"><%= period.label %></strong>
            </div>
            <div class="text-faint">Growth compares to the immediately previous window.</div>
          </div>
          <div class="input-group search-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="search"
              id="orders-search"
              class="form-control search-input"
              placeholder="Search SKU or warehouse..."
            >
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 stack-table" id="orders-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Warehouse</th>
              <th class="text-end">Orders (<span class="period-inline"><%= period.label %></span>)</th>
              <th class="text-end">Prev window</th>
              <th class="text-end">Growth</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(order => { %>
              <% const growth = Number(order.growth || 0); %>
              <% const arrow = growth > 0 ? 'bi-arrow-up-right text-success' : (growth < 0 ? 'bi-arrow-down-right text-danger' : 'bi-dash text-secondary'); %>
              <tr data-filter="<%= `${order.sku} ${order.warehouse_id ?? ''}`.toLowerCase() %>">
                <td data-label="SKU" class="fw-semibold"><%= order.sku %></td>
                <td data-label="Warehouse" class="text-faint"><%= order.warehouse_id ?? 'N/A' %></td>
                <td data-label="Orders" class="text-end"><%= order.orders %></td>
                <td data-label="Prev window" class="text-end text-faint"><%= order.previous_orders %></td>
                <td data-label="Growth" class="text-end">
                  <i class="bi <%= arrow %> me-1"></i>
                  <%= growth.toFixed(1) %>%
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const initialData = {
    inventory: <%- JSON.stringify(inventory) %>,
    orders: <%- JSON.stringify(orders) %>,
    periodKey: '<%= periodKey %>',
  };

  const periodSelect = document.getElementById('period-select');
  const inventorySearch = document.getElementById('inventory-search');
  const ordersSearch = document.getElementById('orders-search');
  const downloadBtn = document.getElementById('download-excel');

  function formatNumber(value) {
    if (value === null || value === undefined) return '0';
    return Number(value).toLocaleString();
  }

  function statusLabel(status) {
    if (status === 'red') return { text: 'Critical', className: 'status-red', row: 'row-critical' };
    if (status === 'purple') return { text: 'Watch', className: 'status-purple', row: 'row-warning' };
    return { text: 'Healthy', className: 'status-green', row: '' };
  }

  function attachSearch(input, tableId) {
    const table = document.getElementById(tableId);
    input?.addEventListener('input', () => applyFilter(table, input.value));
  }

  function applyFilter(table, term) {
    const value = (term || '').toLowerCase();
    table?.querySelectorAll('tbody tr').forEach((row) => {
      const haystack = row.dataset.filter || '';
      row.style.display = haystack.includes(value) ? '' : 'none';
    });
  }

  function updateMetrics(rows = []) {
    const critical = rows.filter((item) => item.status === 'red').length;
    const watch = rows.filter((item) => item.status === 'purple').length;
    const runwayValues = rows
      .map((item) => Number(item.days_left))
      .filter((value) => Number.isFinite(value))
      .sort((a, b) => a - b);

    const midpoint = runwayValues.length ? runwayValues[Math.floor(runwayValues.length / 2)] : 0;

    const criticalEl = document.getElementById('metric-critical');
    const watchEl = document.getElementById('metric-watch');
    const runwayEl = document.getElementById('metric-runway');

    if (criticalEl) criticalEl.textContent = critical.toLocaleString();
    if (watchEl) watchEl.textContent = watch.toLocaleString();
    if (runwayEl) runwayEl.textContent = `${Number(midpoint || 0).toFixed(1)}d`;
  }

  function renderInventory(rows) {
    const tbody = document.querySelector('#inventory-table tbody');
    const searchTerm = inventorySearch?.value || '';
    tbody.innerHTML = rows.map((item) => {
      const infinite = !Number.isFinite(item.days_left);
      const label = statusLabel(item.status);
      return `
        <tr data-filter="${(item.sku + ' ' + (item.warehouse_id || '')).toLowerCase()}" class="${label.row}">
          <td data-label="SKU" class="fw-semibold">${item.sku}</td>
          <td data-label="Warehouse" class="text-faint">${item.warehouse_id ?? 'N/A'}</td>
          <td data-label="Inventory" class="text-end">${formatNumber(item.inventory)}</td>
          <td data-label="Making time" class="text-end">${item.making_time_days}</td>
          <td data-label="Yesterday orders" class="text-end">${item.yesterday_orders}</td>
          <td data-label="Days left" class="text-end">${infinite ? '∞' : Number(item.days_left).toFixed(1)}</td>
          <td data-label="Status"><span class="status-pill ${label.className}">${label.text}</span></td>
        </tr>`;
    }).join('');
    applyFilter(document.getElementById('inventory-table'), searchTerm);
    updateMetrics(rows);
  }

  function renderOrders(rows, periodLabel) {
    const tbody = document.querySelector('#orders-table tbody');
    const searchTerm = ordersSearch?.value || '';
    tbody.innerHTML = rows.map((order) => {
      const growth = Number(order.growth || 0);
      const arrow = growth > 0
        ? 'bi-arrow-up-right text-success'
        : growth < 0
          ? 'bi-arrow-down-right text-danger'
          : 'bi-dash text-secondary';
      return `
        <tr data-filter="${(order.sku + ' ' + (order.warehouse_id || '')).toLowerCase()}">
          <td data-label="SKU" class="fw-semibold">${order.sku}</td>
          <td data-label="Warehouse" class="text-faint">${order.warehouse_id ?? 'N/A'}</td>
          <td data-label="Orders" class="text-end">${order.orders}</td>
          <td data-label="Prev window" class="text-end text-faint">${order.previous_orders}</td>
          <td data-label="Growth" class="text-end"><i class="bi ${arrow} me-1"></i>${growth.toFixed(1)}%</td>
        </tr>`;
    }).join('');
    document.getElementById('orders-period-label').textContent = periodLabel;
    document.querySelector('#orders-table thead .period-inline').textContent = periodLabel;
    applyFilter(document.getElementById('orders-table'), searchTerm);
  }

  async function refreshData() {
    const period = periodSelect?.value || initialData.periodKey;
    const params = new URLSearchParams({ period });
    try {
      const response = await fetch(`${window.location.pathname}/data?${params.toString()}`);
      if (!response.ok) throw new Error('Failed to fetch latest data');
      const payload = await response.json();
      renderInventory(payload.inventory || []);
      renderOrders(payload.orders || [], payload.period.label);
    } catch (err) {
      console.error('Refresh failed:', err);
    }
  }

  attachSearch(inventorySearch, 'inventory-table');
  attachSearch(ordersSearch, 'orders-table');
  periodSelect?.addEventListener('change', () => refreshData());
  downloadBtn?.addEventListener('click', () => {
    const period = periodSelect?.value || initialData.periodKey;
    const params = new URLSearchParams({ period });
    window.location.href = `${window.location.pathname}/download?${params.toString()}`;
  });

  // Hydrate from initial payload so formatting is consistent
  renderInventory(initialData.inventory || []);
  renderOrders(initialData.orders || [], document.getElementById('orders-period-label').textContent);

  setInterval(refreshData, 15000);
</script>
</body>
</html>
