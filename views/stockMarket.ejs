<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Out-of-Stock Control</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/kotty-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/professional.css">

  <style>
    :root {
      --color-bg-primary: #f5f7fb;
      --color-surface: #ffffff;
      --color-surface-alt: #f0f4ff;
      --color-border: #dce4ed;
      --color-text-primary: #0f172a;
      --color-text-secondary: #475569;
      --color-text-muted: #6b7280;
      --color-accent: #0f52ba;
      --color-accent-soft: #e9f0ff;
      --color-danger: #d60036;
      --color-danger-soft: #ffe5ec;
      --color-warning: #7c3aed;
      --color-warning-soft: #f1e9ff;
      --color-success: #0f9d58;
      --shadow-md: 0 12px 20px rgba(15, 82, 186, 0.08);
      --shadow-soft: 0 8px 16px rgba(15, 82, 186, 0.04);
    }

    /* ✅ IMPORTANT: remove safe-area padding from body (it makes sticky huge in webviews) */
    body {
      background: #f6f7fb;
      color: var(--color-text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 15px;
      line-height: 1.55;
      min-height: 100vh;
      padding: 0; /* ✅ */
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden; /* ✅ prevent any horizontal bleed */
    }

    /* ✅ Sticky topbar compact + safe-area only here */
    .topbar {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(220, 228, 237, 0.7);
      position: sticky;
      top: 0;
      z-index: 50;
      padding-top: env(safe-area-inset-top); /* ✅ */
    }

    .topbar .container-fluid {
      padding: 0.85rem 1.25rem;
      flex-wrap: nowrap; /* ✅ no wrap explosion */
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      font-weight: 800;
      letter-spacing: -0.01em;
      color: var(--color-text-primary);
      text-decoration: none;
      flex: 1 1 auto;   /* ✅ */
      min-width: 0;     /* ✅ */
    }

    .brand .logo-mark {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, #0f52ba, #2563eb);
      display: grid;
      place-items: center;
      color: #fff;
      box-shadow: 0 10px 24px rgba(15, 82, 186, 0.22);
      font-size: 1.15rem;
      flex: 0 0 auto;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      min-width: 0;
      line-height: 1.15;
    }

    .brand-title {
      font-weight: 800;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .brand-subtitle {
      color: var(--color-text-muted);
      font-weight: 600;
    }

    .topbar-actions {
      flex: 0 0 auto;
      min-width: 0;
    }

    .user-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.55rem 0.95rem;
      border-radius: 999px;
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
      font-weight: 600;
      border: 1px solid rgba(15, 82, 186, 0.12);
      max-width: 220px;
    }

    .user-chip i { color: var(--color-accent); }

    .user-chip .user-name {
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
    }

    /* ✅ Mobile-first shell padding + safe-area bottom only here */
    .stock-shell {
      max-width: 1140px;
      margin: 0 auto;
      width: min(1140px, 100%);
      padding: 12px 12px calc(16px + env(safe-area-inset-bottom)); /* ✅ */
    }

    .hero-card {
      background: #ffffff;
      border: 1px solid rgba(15, 82, 186, 0.1);
      border-radius: 16px;
      padding: 1.15rem 1rem;
      box-shadow: 0 6px 16px rgba(15, 82, 186, 0.06);
      display: grid;
      gap: 0.85rem;
    }

    .hero-heading {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 700;
      color: var(--color-accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.85rem;
    }

    h1.page-title {
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: clamp(1.25rem, 3.3vw, 1.8rem);
      margin: 0;
    }

    .lede-text {
      color: var(--color-text-secondary);
      font-weight: 500;
      margin: 0;
      line-height: 1.5;
    }

    .status-helper {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--color-text-muted);
      font-weight: 700;
    }

    .tooltip-icon {
      color: var(--color-text-secondary);
      cursor: help;
    }

    .hero-actions {
      display: grid;
      gap: 0.5rem;
      width: 100%;
    }

    .action-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.5rem;
      align-items: center;
    }

    .control-chip {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.55rem 0.75rem;
      border-radius: 12px;
      background: var(--color-surface);
      border: 1px solid rgba(15, 82, 186, 0.12);
      box-shadow: var(--shadow-soft);
    }

    .control-chip label {
      font-weight: 700;
      color: var(--color-text-secondary);
      margin: 0;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .control-chip select {
      border-radius: 10px;
      border: 1px solid var(--color-border);
      padding: 0.5rem 0.7rem;
      font-weight: 600;
      color: var(--color-text-primary);
      font-size: 0.95rem;
      min-height: 40px;
    }

    .hero-actions .btn { width: 100%; }

    .stat-card {
      border-radius: 14px;
      border: 1px solid rgba(15, 82, 186, 0.08);
      background: var(--color-surface);
      box-shadow: var(--shadow-soft);
      padding: 0.9rem 0.95rem;
      display: grid;
      gap: 0.15rem;
    }

    .stat-label { color: var(--color-text-muted); font-weight: 700; font-size: 0.9rem; }
    .stat-value { font-size: clamp(1.4rem, 4vw, 1.8rem); font-weight: 800; letter-spacing: -0.02em; }
    .stat-subtle { color: var(--color-text-secondary); font-weight: 600; font-size: 0.9rem; }

    .action-card {
      border: 1px dashed rgba(15, 82, 186, 0.2);
      border-radius: 14px;
      background: rgba(15, 82, 186, 0.04);
      color: var(--color-accent);
      box-shadow: var(--shadow-soft);
      padding: 0.85rem 0.95rem;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .action-card:hover {
      border-color: var(--color-accent);
      text-decoration: none;
      box-shadow: 0 14px 24px rgba(15, 82, 186, 0.14);
    }

    .card-pane {
      background: var(--color-surface);
      border: 1px solid rgba(15, 82, 186, 0.08);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
    }

    .card-pane .card-body {
      padding: 1.25rem 1.1rem;
    }

    .tab-nav {
      background: var(--color-surface);
      border-radius: 14px;
      border: 1px solid rgba(15, 82, 186, 0.08);
      padding: 0.35rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.35rem;
      box-shadow: var(--shadow-soft);
    }

    .tab-nav .nav-link {
      width: 100%;
      text-align: center;
      padding: 0.8rem 0.9rem;
      font-weight: 700;
      color: var(--color-text-secondary);
      border-radius: 12px;
      border: 1px solid transparent;
    }

    .tab-nav .nav-link.active {
      background: linear-gradient(135deg, #0f52ba, #2563eb);
      color: #fff;
      box-shadow: 0 10px 18px rgba(15, 82, 186, 0.25);
      border-color: rgba(15, 82, 186, 0.18);
    }

    .status-pill {
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-weight: 800;
      font-size: 0.92rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.01em;
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-pill::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 0 6px rgba(0, 0, 0, 0.04);
      flex: 0 0 auto;
    }

    .status-red { background: var(--color-danger-soft); color: var(--color-danger); border-color: rgba(214, 0, 54, 0.24); }
    .status-purple { background: var(--color-warning-soft); color: var(--color-warning); border-color: rgba(124, 58, 237, 0.22); }
    .status-green { background: #e8f5ef; color: var(--color-success); border-color: rgba(15, 157, 88, 0.2); }

    .search-group { width: 100%; }

    .search-input {
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 0.85rem 1rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .soft-btn {
      background: rgba(15, 82, 186, 0.06);
      border: 1px solid rgba(15, 82, 186, 0.18);
      color: var(--color-accent);
      box-shadow: var(--shadow-soft);
    }

    .soft-btn:hover {
      background: rgba(15, 82, 186, 0.12);
      color: var(--color-accent);
    }

    .soft-btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .btn .spinner-border {
      width: 1rem;
      height: 1rem;
      border-width: 2px;
    }

    .input-group-text {
      border-color: var(--color-border);
      background: var(--color-accent-soft);
      color: var(--color-accent);
      border-radius: 12px 0 0 12px !important;
    }

    .table { color: var(--color-text-primary); font-size: 1rem; width: 100%; }
    .table thead { display: none; }
    .table thead th {
      background: #f0f4f9;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table.stack-table tbody { display: grid; gap: 0.85rem; }
    .table.stack-table tbody tr {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.55rem 0.75rem;
      padding: 1rem 0.95rem 0.75rem;
      border: 1px solid rgba(15, 82, 186, 0.12);
      border-radius: 16px;
      background: #fff;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden; /* ✅ stop any internal overflow */
    }

    .table.stack-table tbody tr.row-critical { background: linear-gradient(180deg, rgba(214, 0, 54, 0.06), rgba(214, 0, 54, 0.01)); }
    .table.stack-table tbody tr.row-warning { background: linear-gradient(180deg, rgba(124, 58, 237, 0.05), rgba(124, 58, 237, 0.01)); }

    .table.stack-table tbody td {
      padding: 0.35rem 0;
      text-align: left !important;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.65rem;
      width: 100%;
      min-width: 0; /* ✅ critical */
    }

    .table.stack-table tbody td::before {
      content: attr(data-label);
      font-weight: 700;
      color: var(--color-text-secondary);
      margin-right: 0.5rem;
      flex: 1;
      max-width: 160px;
      min-width: 0;
    }

    .table.stack-table tbody td:last-child {
      grid-column: 1 / -1;
      justify-content: flex-start;
      align-items: center;
    }

    .sku-text {
      font-weight: 800;
      letter-spacing: -0.01em;
      word-break: break-word;
      overflow-wrap: anywhere; /* ✅ long SKU never breaks layout */
      line-height: 1.4;
      min-width: 0;
    }

    .warehouse-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.7rem;
      border-radius: 10px;
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
      font-weight: 700;
      border: 1px solid rgba(15, 82, 186, 0.12);

      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }

    .table.stack-table tbody tr .warehouse-pill {
      background: #eef3ff;
      border-color: rgba(15, 82, 186, 0.25);
      color: var(--color-text-primary);
      font-weight: 700;
    }

    .metric-label { color: var(--color-text-secondary); font-weight: 700; font-size: 0.95rem; }
    .text-faint { color: var(--color-text-muted); }

    .table-responsive { overflow: visible; }

    @media (min-width: 768px) {
      body { font-size: 17px; }
      .hero-card { padding: 1.6rem; grid-template-columns: 1.2fr 1fr; align-items: center; }
      .hero-actions .btn { width: auto; }
      .search-group { max-width: 480px; }
    }

    @media (min-width: 992px) {
      .card-pane .card-body { padding: 1.4rem 1.35rem; }
      .table-responsive { overflow-x: auto; }
      .table { font-size: 1rem; }
      .table thead { display: table-header-group; }
      .table.stack-table { display: table; }
      .table.stack-table tbody { display: table-row-group; }
      .table.stack-table tbody tr { display: table-row; box-shadow: none; border: none; border-radius: 0; background: transparent; overflow: visible; }
      .table.stack-table tbody td {
        display: table-cell;
        padding: 0.85rem 0.7rem;
        vertical-align: middle;
        text-align: right !important;
      }
      .table.stack-table tbody td:first-child,
      .table.stack-table tbody td:nth-child(2) { text-align: left !important; }
      .table.stack-table tbody td::before { display: none; }
      .table.stack-table tbody td:last-child { grid-column: auto; }
      .tab-nav { grid-template-columns: repeat(2, max-content); width: fit-content; }
      .tab-nav .nav-link { padding-inline: 1.5rem; }
    }

    /* ✅ MOBILE: compact sticky + single column actions */
    @media (max-width: 575.98px) {
      .topbar .container-fluid {
        padding: 0.55rem 0.75rem;
        gap: 0.5rem !important;
      }

      .brand { gap: 0.5rem; }
      .brand .logo-mark {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        font-size: 0.95rem;
      }

      .brand-title { font-size: 0.98rem; }
      .user-chip {
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
        gap: 0.4rem;
        max-width: 180px;
      }
      .user-chip .user-name { max-width: 110px; }

      .hero-card { padding: 1rem 0.9rem; gap: 0.75rem; }
      .eyebrow { font-size: 0.78rem; }
      h1.page-title { font-size: 1.2rem; }
      .lede-text { font-size: 0.95rem; }

      .action-row { grid-template-columns: 1fr !important; }
      .action-row .btn { min-height: 44px; }

      .control-chip { padding: 0.5rem 0.6rem; border-radius: 12px; }
      .control-chip label { font-size: 0.85rem; }
      .control-chip select { min-height: 42px; font-size: 0.95rem; }

      .search-input { padding: 0.75rem 0.85rem; }
      .input-group-text { padding: 0.75rem 0.85rem; }

      /* =========================================================
         ✅ BIG FIX: Mobile table cards become single-column
         so nothing is packed / overflowing
         ========================================================= */
      .table.stack-table tbody tr{
        grid-template-columns: 1fr !important;
        gap: 0.6rem !important;
        padding: 0.95rem 0.85rem 0.8rem !important;
      }

      .table.stack-table tbody td{
        display: block !important;
        padding: 0.55rem 0 !important;
        text-align: left !important;
      }

      .table.stack-table tbody td::before{
        display: block !important;
        max-width: none !important;
        margin: 0 0 0.25rem 0 !important;
        font-size: 0.88rem;
        opacity: 0.9;
      }

      .table.stack-table tbody td:last-child{
        grid-column: auto !important;
        justify-content: flex-start !important;
        align-items: flex-start !important;
      }

      .status-pill{
        font-size: 0.85rem !important;
        padding: 0.35rem 0.65rem !important;
      }
    }

    /* ✅ Ultra-small phones: hide username text */
    @media (max-width: 380px) {
      .user-chip .user-name { display: none; }
    }

    @media print {
      body { background: #fff; }
      .topbar, .tab-nav, .input-group, .hero-card, .action-card { display: none !important; }
      .status-pill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .table tbody tr { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>

<body>
<% const isMohitOperator = (user?.username || '').toLowerCase() === 'mohitoperator'; %>
<% const hasWarehouseChoice = (accessibleWarehouses || []).length > 1; %>

<div class="topbar">
  <div class="container-fluid d-flex align-items-center justify-content-between gap-3">
    <a class="brand" href="/dashboard">
      <span class="logo-mark">OS</span>
      <span class="brand-text">
        <span class="brand-title">Out-of-stock control</span>
        <small class="brand-subtitle d-none d-sm-block">Warehouses, runway, and gaps</small>
      </span>
    </a>

    <div class="d-flex align-items-center gap-2 topbar-actions">
      <% if (user) { %>
        <span class="user-chip">
          <i class="bi bi-person-circle"></i>
          <span class="user-name"><%= user.username || user.name %></span>
        </span>
      <% } %>

      <a href="/logout" class="btn btn-light btn-sm d-inline-flex d-sm-none align-items-center gap-1">
        <i class="bi bi-box-arrow-right"></i>
      </a>

      <a href="/logout" class="btn btn-outline-secondary btn-sm d-none d-sm-inline-flex align-items-center gap-2">
        <i class="bi bi-box-arrow-right"></i>
        Logout
      </a>
    </div>
  </div>
</div>

<div class="stock-shell">
  <div class="hero-card mb-3">
    <div class="hero-heading">
      <span class="eyebrow"><i class="bi bi-activity"></i> Live runway</span>
      <h1 class="page-title">Out-of-stock coverage with warehouse focus</h1>
      <p class="lede-text mb-1">Trimmed down to the essentials so you can spot gaps faster.</p>
    </div>

    <div class="hero-actions">
      <div class="action-row">
        <button class="btn soft-btn d-flex align-items-center justify-content-center gap-2" id="refresh-view" type="button" data-bs-toggle="tooltip" data-bs-title="Pull the latest inventory, orders, and slow movers">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          <i class="bi bi-arrow-clockwise"></i>
          <span class="d-none d-sm-inline">Refresh view</span>
          <span class="d-sm-none">Refresh</span>
        </button>

        <% if (isMohitOperator) { %>
          <a class="btn btn-outline-primary d-flex align-items-center justify-content-center gap-2" href="/easyecom/stock-market/making-time" data-bs-toggle="tooltip" data-bs-title="Upload making time rows for out-of-stock SKUs">
            <i class="bi bi-upload"></i><span>Bulk making time</span>
          </a>
          <a class="btn btn-outline-secondary d-flex align-items-center justify-content-center gap-2" href="/easyecom/warehouse-access" data-bs-toggle="tooltip" data-bs-title="Grant warehouse visibility to Out-of-Stock users">
            <i class="bi bi-building-gear"></i><span>Warehouse access</span>
          </a>
        <% } %>

        <button class="btn btn-success d-flex align-items-center justify-content-center gap-2" id="download-excel" type="button" data-bs-toggle="tooltip" data-bs-title="Export the current filters as Excel">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          <i class="bi bi-file-earmark-excel"></i><span>Download Excel</span>
        </button>
      </div>

      <div class="action-row">
        <div class="control-chip w-100">
          <label for="period-select">Period</label>
          <select class="form-select" id="period-select" name="period">
            <% Object.entries(periodPresets).forEach(([key, preset]) => { %>
              <option value="<%= key %>" <%= key === periodKey ? 'selected' : '' %>>
                <%= preset.label %>
              </option>
            <% }); %>
          </select>
        </div>
        <% if (hasWarehouseChoice) { %>
          <div class="control-chip w-100">
            <label for="warehouse-select">Warehouse</label>
            <select class="form-select" id="warehouse-select" name="warehouseId" data-bs-toggle="tooltip" data-bs-title="Switch warehouses to see out-of-stock gaps per site">
              <% accessibleWarehouses.forEach((wh) => { %>
                <option value="<%= wh.id %>" <%= Number(selectedWarehouseId) === Number(wh.id) ? 'selected' : '' %>>
                  <%= wh.label %>
                </option>
              <% }); %>
            </select>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="stat-card" data-bs-toggle="tooltip" data-bs-title="SKUs that will run out first based on yesterday's orders">
        <div class="stat-label">Critical SKUs</div>
        <div class="stat-value" id="metric-critical">0</div>
        <div class="stat-subtle">Need replenishment now</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="stat-card" data-bs-toggle="tooltip" data-bs-title="SKUs trending towards risk but not yet critical">
        <div class="stat-label">On watch</div>
        <div class="stat-value" id="metric-watch">0</div>
        <div class="stat-subtle">Monitor before they slip</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="stat-card" data-bs-toggle="tooltip" data-bs-title="Median days left based on current run rate">
        <div class="stat-label">Median runway</div>
        <div class="stat-value" id="metric-runway">0d</div>
        <div class="stat-subtle">Across SKUs in view</div>
      </div>
    </div>
  </div>

  <div class="card-pane">
    <div class="card-body">
      <ul class="nav nav-pills tab-nav mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="inventory-tab" data-bs-toggle="pill" data-bs-target="#inventory" type="button" role="tab">
            <i class="bi bi-box-seam me-2"></i>Inventory
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button" role="tab">
            <i class="bi bi-cart-check me-2"></i>Orders
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="slow-tab" data-bs-toggle="pill" data-bs-target="#slow" type="button" role="tab">
            <i class="bi bi-hourglass-split me-2"></i>Slow movers
          </button>
        </li>
      </ul>

      <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="inventory" role="tabpanel">
          <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-3">
            <div class="status-helper" data-bs-toggle="tooltip" data-bs-title="Use the filters to show only critical, watch, or healthy SKUs. Colors match the runway calculation.">
              <i class="bi bi-info-circle tooltip-icon"></i>
              <span>Status filters guide what shows up here.</span>
            </div>
            <div class="btn-group status-filters" role="group" aria-label="Filter by status">
              <input type="radio" class="btn-check" name="status-filter" id="status-all" autocomplete="off" value="all" checked>
              <label class="btn btn-outline-secondary" for="status-all">All</label>
              <input type="radio" class="btn-check" name="status-filter" id="status-critical" autocomplete="off" value="red">
              <label class="btn btn-outline-danger" for="status-critical">Critical</label>
              <input type="radio" class="btn-check" name="status-filter" id="status-watch" autocomplete="off" value="purple">
              <label class="btn btn-outline-warning" for="status-watch">Watch</label>
              <input type="radio" class="btn-check" name="status-filter" id="status-healthy" autocomplete="off" value="green">
              <label class="btn btn-outline-success" for="status-healthy">Healthy</label>
            </div>
            <div class="input-group search-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="search" id="inventory-search" class="form-control search-input" placeholder="Search SKU...">
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 stack-table" id="inventory-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th class="text-end">Inventory</th>
                  <th class="text-end">Making time (days)</th>
                  <th class="text-end">Yesterday orders</th>
                  <th class="text-end">Days left</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <% inventory.forEach(item => { %>
                  <% const infinite = !Number.isFinite(item.days_left); %>
                  <tr data-filter="<%= `${item.sku}`.toLowerCase() %>" class="<%= item.status === 'red' ? 'row-critical' : item.status === 'purple' ? 'row-warning' : '' %>">
                    <td data-label="SKU" class="sku-text"><%= item.sku %></td>
                    <td data-label="Inventory" class="text-end"><%= item.inventory.toLocaleString() %></td>
                    <td data-label="Making time" class="text-end"><%= item.making_time_days %></td>
                    <td data-label="Yesterday orders" class="text-end"><%= item.yesterday_orders %></td>
                    <td data-label="Days left" class="text-end"><%= infinite ? '∞' : item.days_left.toFixed(1) %></td>
                    <td data-label="Status">
                      <% if (item.status === 'red') { %>
                        <span class="status-pill status-red">Critical</span>
                      <% } else if (item.status === 'purple') { %>
                        <span class="status-pill status-purple">Watch</span>
                      <% } else { %>
                        <span class="status-pill status-green">Healthy</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="orders" role="tabpanel">
          <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-3">
            <div>
              <div class="metric-label">
                Orders ranked by volume for <strong id="orders-period-label"><%= period.label %></strong>
              </div>
              <div class="text-faint">Growth compares to the immediately previous window.</div>
            </div>
            <div class="input-group search-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="search" id="orders-search" class="form-control search-input" placeholder="Search SKU...">
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 stack-table" id="orders-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Warehouse</th>
                  <th class="text-end">Orders (<span class="period-inline"><%= period.label %></span>)</th>
                  <th class="text-end">Prev window</th>
                  <th class="text-end">Growth</th>
                </tr>
              </thead>
              <tbody>
                <% orders.forEach(order => { %>
                  <% const growth = Number(order.growth || 0); %>
                  <% const arrow = growth > 0 ? 'bi-arrow-up-right text-success' : (growth < 0 ? 'bi-arrow-down-right text-danger' : 'bi-dash text-secondary'); %>
                  <tr data-filter="<%= `${order.sku}`.toLowerCase() %>">
                    <td data-label="SKU" class="sku-text"><%= order.sku %></td>
                    <td data-label="Warehouse">
                      <span class="warehouse-pill"><i class="bi bi-geo-alt"></i><%= order.warehouse_label ?? order.warehouse_id ?? 'N/A' %></span>
                    </td>
                    <td data-label="Orders" class="text-end"><%= order.orders %></td>
                    <td data-label="Prev window" class="text-end text-faint"><%= order.previous_orders %></td>
                    <td data-label="Growth" class="text-end">
                      <i class="bi <%= arrow %> me-1"></i>
                      <%= growth.toFixed(1) %>%
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="slow" role="tabpanel">
          <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-3">
            <div>
              <div class="metric-label d-flex align-items-center gap-2">
                <span>High inventory, low sales</span>
                <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip" data-bs-title="Sorted by lowest 30d orders, then 7d orders, then highest on-hand inventory."></i>
              </div>
              <div class="text-faint">Shows SKUs (with making time set) that sold 10 or fewer units in both 7d and 30d windows.</div>
            </div>
            <div class="input-group search-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="search" id="slow-search" class="form-control search-input" placeholder="Search SKU...">
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 stack-table" id="slow-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Warehouse</th>
                  <th class="text-end">Inventory</th>
                  <th class="text-end">Orders (7d)</th>
                  <th class="text-end">Orders (30d)</th>
                </tr>
              </thead>
              <tbody>
                <% slowMovers.forEach((row) => { %>
                  <tr data-filter="<%= `${row.sku}`.toLowerCase() %>">
                    <td data-label="SKU" class="sku-text"><%= row.sku %></td>
                    <td data-label="Warehouse"><span class="warehouse-pill"><i class="bi bi-geo-alt"></i><%= row.warehouse_label ?? row.warehouse_id ?? 'N/A' %></span></td>
                    <td data-label="Inventory" class="text-end"><%= (Number(row.inventory) || 0).toLocaleString() %></td>
                    <td data-label="Orders (7d)" class="text-end"><%= row.orders_7d %></td>
                    <td data-label="Orders (30d)" class="text-end"><%= row.orders_30d %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const initialData = {
    inventory: <%- JSON.stringify(inventory) %>,
    orders: <%- JSON.stringify(orders) %>,
    slowMovers: <%- JSON.stringify(slowMovers) %>,
    periodKey: '<%= periodKey %>',
  };

  const periodSelect = document.getElementById('period-select');
  const inventorySearch = document.getElementById('inventory-search');
  const ordersSearch = document.getElementById('orders-search');
  const slowSearch = document.getElementById('slow-search');
  const downloadBtn = document.getElementById('download-excel');
  const refreshBtn = document.getElementById('refresh-view');
  const warehouseSelect = document.getElementById('warehouse-select');
  const statusFilterInputs = document.querySelectorAll('input[name="status-filter"]');

  const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));

  let inventoryRows = initialData.inventory || [];
  let orderRows = initialData.orders || [];
  let slowMoverRows = initialData.slowMovers || [];
  let activeStatus = 'all';

  function toggleRefreshState(isLoading) {
    if (!refreshBtn) return;
    const spinner = refreshBtn.querySelector('.spinner-border');
    const icon = refreshBtn.querySelector('.bi-arrow-clockwise');
    refreshBtn.disabled = isLoading;
    spinner?.classList.toggle('d-none', !isLoading);
    icon?.classList.toggle('d-none', isLoading);
  }

  function parseFilenameFromHeader(disposition) {
    if (!disposition) return '';
    const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
    if (utfMatch && utfMatch[1]) {
      return decodeURIComponent(utfMatch[1]);
    }
    const asciiMatch = disposition.match(/filename=\"?([^\";]+)\"?/i);
    return asciiMatch && asciiMatch[1] ? asciiMatch[1] : '';
  }

  function formatNumber(value) {
    if (value === null || value === undefined) return '0';
    return Number(value).toLocaleString();
  }

  function statusLabel(status) {
    if (status === 'red') return { text: 'Critical', className: 'status-red', row: 'row-critical' };
    if (status === 'purple') return { text: 'Watch', className: 'status-purple', row: 'row-warning' };
    return { text: 'Healthy', className: 'status-green', row: '' };
  }

  function attachSearch(input, tableId) {
    const table = document.getElementById(tableId);
    input?.addEventListener('input', () => applyFilter(table, input.value));
  }

  function applyFilter(table, term) {
    const value = (term || '').toLowerCase();
    table?.querySelectorAll('tbody tr').forEach((row) => {
      const haystack = row.dataset.filter || '';
      row.style.display = haystack.includes(value) ? '' : 'none';
    });
  }

  function updateMetrics(rows = []) {
    const critical = rows.filter((item) => item.status === 'red').length;
    const watch = rows.filter((item) => item.status === 'purple').length;
    const runwayValues = rows
      .map((item) => Number(item.days_left))
      .filter((value) => Number.isFinite(value))
      .sort((a, b) => a - b);

    const midpoint = runwayValues.length ? runwayValues[Math.floor(runwayValues.length / 2)] : 0;

    const criticalEl = document.getElementById('metric-critical');
    const watchEl = document.getElementById('metric-watch');
    const runwayEl = document.getElementById('metric-runway');

    if (criticalEl) criticalEl.textContent = critical.toLocaleString();
    if (watchEl) watchEl.textContent = watch.toLocaleString();
    if (runwayEl) runwayEl.textContent = `${Number(midpoint || 0).toFixed(1)}d`;
  }

  function getFilteredInventoryRows() {
    if (activeStatus === 'all') return inventoryRows;
    return inventoryRows.filter((row) => row.status === activeStatus);
  }

  function renderInventory(rows) {
    const tbody = document.querySelector('#inventory-table tbody');
    const searchTerm = inventorySearch?.value || '';
    tbody.innerHTML = rows.map((item) => {
      const infinite = !Number.isFinite(item.days_left);
      const label = statusLabel(item.status);
      return `
        <tr data-filter="${(item.sku).toLowerCase()}" class="${label.row}">
          <td data-label="SKU" class="sku-text">${item.sku}</td>
          <td data-label="Inventory" class="text-end">${formatNumber(item.inventory)}</td>
          <td data-label="Making time" class="text-end">${item.making_time_days}</td>
          <td data-label="Yesterday orders" class="text-end">${item.yesterday_orders}</td>
          <td data-label="Days left" class="text-end">${infinite ? '∞' : Number(item.days_left).toFixed(1)}</td>
          <td data-label="Status"><span class="status-pill ${label.className}">${label.text}</span></td>
        </tr>`;
    }).join('');
    applyFilter(document.getElementById('inventory-table'), searchTerm);
    updateMetrics(rows);
  }

  function renderOrders(rows, periodLabel) {
    const tbody = document.querySelector('#orders-table tbody');
    const searchTerm = ordersSearch?.value || '';
    tbody.innerHTML = rows.map((order) => {
      const growth = Number(order.growth || 0);
      const arrow = growth > 0
        ? 'bi-arrow-up-right text-success'
        : growth < 0
          ? 'bi-arrow-down-right text-danger'
          : 'bi-dash text-secondary';
      return `
        <tr data-filter="${(order.sku).toLowerCase()}">
          <td data-label="SKU" class="sku-text">${order.sku}</td>
          <td data-label="Warehouse"><span class="warehouse-pill"><i class="bi bi-geo-alt"></i>${order.warehouse_label ?? order.warehouse_id ?? 'N/A'}</span></td>
          <td data-label="Orders" class="text-end">${order.orders}</td>
          <td data-label="Prev window" class="text-end text-faint">${order.previous_orders}</td>
          <td data-label="Growth" class="text-end"><i class="bi ${arrow} me-1"></i>${growth.toFixed(1)}%</td>
        </tr>`;
    }).join('');
    document.getElementById('orders-period-label').textContent = periodLabel;
    document.querySelector('#orders-table thead .period-inline').textContent = periodLabel;
    applyFilter(document.getElementById('orders-table'), searchTerm);
  }

  function renderSlowMovers(rows) {
    const tbody = document.querySelector('#slow-table tbody');
    const searchTerm = slowSearch?.value || '';
    tbody.innerHTML = rows.map((row) => {
      const warehouseText = row.warehouse_label ?? row.warehouse_id ?? 'N/A';
      return `
        <tr data-filter="${`${row.sku} ${warehouseText}`.toLowerCase()}">
          <td data-label="SKU" class="sku-text">${row.sku}</td>
          <td data-label="Warehouse"><span class="warehouse-pill"><i class="bi bi-geo-alt"></i>${warehouseText}</span></td>
          <td data-label="Inventory" class="text-end">${formatNumber(row.inventory)}</td>
          <td data-label="Orders (7d)" class="text-end">${row.orders_7d}</td>
          <td data-label="Orders (30d)" class="text-end">${row.orders_30d}</td>
        </tr>
      `;
    }).join('');
    applyFilter(document.getElementById('slow-table'), searchTerm);
  }

  function rankSlowMovers(rows = []) {
    return [...rows].sort((a, b) => {
      if (a.orders_30d !== b.orders_30d) return a.orders_30d - b.orders_30d;
      if (a.orders_7d !== b.orders_7d) return a.orders_7d - b.orders_7d;
      return (Number(b.inventory) || 0) - (Number(a.inventory) || 0);
    });
  }

  async function refreshData(triggeredByButton = false) {
    toggleRefreshState(triggeredByButton);
    const period = periodSelect?.value || initialData.periodKey;
    const params = new URLSearchParams({ period });
    if (warehouseSelect?.value) params.set('warehouseId', warehouseSelect.value);
    try {
      const response = await fetch(`${window.location.pathname}/data?${params.toString()}`);
      if (!response.ok) throw new Error('Failed to fetch latest data');
      const payload = await response.json();
      inventoryRows = payload.inventory || [];
      orderRows = payload.orders || [];
      slowMoverRows = rankSlowMovers(payload.slowMovers || []);
      renderInventory(getFilteredInventoryRows());
      renderOrders(orderRows, payload.period.label);
      renderSlowMovers(slowMoverRows);
    } catch (err) {
      console.error('Refresh failed:', err);
    } finally {
      toggleRefreshState(false);
    }
  }

  attachSearch(inventorySearch, 'inventory-table');
  attachSearch(ordersSearch, 'orders-table');
  attachSearch(slowSearch, 'slow-table');
  periodSelect?.addEventListener('change', () => refreshData());
  refreshBtn?.addEventListener('click', () => refreshData(true));
  warehouseSelect?.addEventListener('change', () => {
    const params = new URLSearchParams(window.location.search);
    params.set('warehouseId', warehouseSelect.value);
    if (periodSelect?.value) params.set('period', periodSelect.value);
    window.location.href = `${window.location.pathname}?${params.toString()}`;
  });
  statusFilterInputs?.forEach((input) => {
    input.addEventListener('change', (event) => {
      activeStatus = event.target.value || 'all';
      renderInventory(getFilteredInventoryRows());
    });
  });
  downloadBtn?.addEventListener('click', async () => {
    const spinner = downloadBtn.querySelector('.spinner-border');
    const icon = downloadBtn.querySelector('.bi-file-earmark-excel');
    downloadBtn.disabled = true;
    spinner?.classList.remove('d-none');
    icon?.classList.add('d-none');

    try {
      const period = periodSelect?.value || initialData.periodKey;
      const params = new URLSearchParams({ period });
      if (warehouseSelect?.value) params.set('warehouseId', warehouseSelect.value);
      const response = await fetch(`${window.location.pathname}/download?${params.toString()}`, {
        headers: { Accept: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' },
      });
      if (!response.ok) throw new Error('Failed to download Excel');

      const blob = await response.blob();
      const filename = parseFilenameFromHeader(response.headers.get('content-disposition')) || `out-of-stock-${period}.xlsx`;
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(link.href);
        link.remove();
      }, 400);
    } catch (err) {
      console.error('Download failed:', err);
      alert('Could not download the Excel file. Please try again.');
    } finally {
      spinner?.classList.add('d-none');
      icon?.classList.remove('d-none');
      downloadBtn.disabled = false;
    }
  });

  slowMoverRows = rankSlowMovers(slowMoverRows);
  renderInventory(getFilteredInventoryRows());
  renderOrders(orderRows, document.getElementById('orders-period-label').textContent);
  renderSlowMovers(slowMoverRows);

  setInterval(refreshData, 15000);
</script>
</body>
</html>
