<!DOCTYPE html>
<html>
<head>
  <title>Challan Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS CDN for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4">Challan Dashboard</h1>
    
    <!-- Flash messages -->
    <% if (error && error.length) { %>
      <div class="alert alert-danger">
        <% error.forEach(msg => { %>
          <p><%= msg %></p>
        <% }); %>
      </div>
    <% } %>
    
    <% if (success && success.length) { %>
      <div class="alert alert-success">
        <% success.forEach(msg => { %>
          <p><%= msg %></p>
        <% }); %>
      </div>
    <% } %>

    <!-- Search Input -->
    <div class="form-group">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by SKU, Lot No, or Cutting Remark" value="<%= search %>">
    </div>

    <!-- Challan Assignments Table -->
    <table class="table table-striped table-bordered" id="assignmentsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Lot No</th>
          <th>SKU</th>
          <th>Total Pieces</th>
          <th>Assembly Remark</th>
          <th>Cutting Remark</th>
          <th>Target Day</th>
          <th>Assigned On</th>
          <th>Approval Status</th>
          <th>Assignment Remark</th>
          <th>Washer</th>
          <th>Master</th>
        </tr>
      </thead>
      <tbody>
        <% if (assignments && assignments.length) { %>
          <% assignments.forEach(a => { %>
            <tr>
              <td><%= a.washing_id %></td>
              <td><%= a.lot_no %></td>
              <td><%= a.sku %></td>
              <td><%= a.total_pieces %></td>
              <td><%= a.assembly_remark %></td>
              <td><%= a.cutting_remark %></td>
              <td><%= a.target_day ? new Date(a.target_day).toLocaleDateString() : '' %></td>
              <td><%= a.assigned_on ? new Date(a.assigned_on).toLocaleString() : '' %></td>
              <td>
                <% if (a.is_approved === 1) { %>
                  <span class="badge badge-success">Approved</span>
                <% } else if (a.is_approved === 0) { %>
                  <span class="badge badge-danger">Denied</span>
                <% } else { %>
                  <span class="badge badge-warning">Pending</span>
                <% } %>
              </td>
              <td><%= a.assignment_remark || '' %></td>
              <td><%= a.washer_username %></td>
              <td><%= a.master_username %></td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr>
            <td colspan="12" class="text-center">No records found.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- JavaScript for Realtime Search -->
  <script>
    // Debounce function: delays execution until user stops typing for a specified delay.
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Fetch search results from our API endpoint.
    async function fetchSearchResults(query) {
      try {
        const response = await fetch('/challandashboard/search?search=' + encodeURIComponent(query));
        const data = await response.json();
        updateTable(data.assignments);
      } catch (error) {
        console.error('Error fetching search results:', error);
      }
    }

    // Update the table with new results.
    function updateTable(assignments) {
      const tbody = document.querySelector('#assignmentsTable tbody');
      tbody.innerHTML = '';
      if (assignments && assignments.length) {
        assignments.forEach(a => {
          const approvalBadge = (a.is_approved === 1) ? '<span class="badge badge-success">Approved</span>' :
                                (a.is_approved === 0) ? '<span class="badge badge-danger">Denied</span>' :
                                '<span class="badge badge-warning">Pending</span>';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${a.washing_id}</td>
            <td>${a.lot_no}</td>
            <td>${a.sku}</td>
            <td>${a.total_pieces}</td>
            <td>${a.assembly_remark || ''}</td>
            <td>${a.cutting_remark || ''}</td>
            <td>${a.target_day ? new Date(a.target_day).toLocaleDateString() : ''}</td>
            <td>${a.assigned_on ? new Date(a.assigned_on).toLocaleString() : ''}</td>
            <td>${approvalBadge}</td>
            <td>${a.assignment_remark || ''}</td>
            <td>${a.washer_username}</td>
            <td>${a.master_username}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="12" class="text-center">No records found.</td></tr>`;
      }
    }

    // Listen for input events and perform a debounced search.
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce((e) => {
      fetchSearchResults(e.target.value);
    }, 300));  // Adjust the delay (in milliseconds) as needed.
  </script>
</body>
</html>
