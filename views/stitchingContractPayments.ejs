<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stitching Contract Payments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand">Contract Payments</span>
      <div class="d-flex gap-2 ms-auto">
        <a href="/stitchingdashboard/payments/contract/history" class="btn btn-outline-light btn-sm">History</a>
        <a href="/stitchingdashboard" class="btn btn-outline-light btn-sm">Back</a>
      </div>
    </div>
  </nav>
  <div class="container mt-4">
  <form id="payForm">
    <input type="text" id="searchTable" class="form-control mb-3" placeholder="Search lot or SKU">
    <table class="table table-bordered" id="paymentsTable">
      <thead>
        <tr>
          <th>Select</th>
          <th>Lot</th>
          <th>SKU</th>
          <th>Cutting Remark</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        <% lots.forEach(function(l){ %>
        <tr>
          <td><input type="checkbox" name="lotIds" value="<%= l.id %>"></td>
          <td><%= l.lot_no %></td>
          <td><%= l.sku %></td>
          <td><%= l.cutting_remark || '' %></td>
          <td><%= l.total_pieces %></td>
          <td><%= l.rate %></td>
          <td><%= l.amount %></td>
        </tr>
        <% }) %>
      </tbody>
    </table>
    <div class="text-end">
      <button type="button" id="payBtn" class="btn btn-primary">Get Paid</button>
    </div>
  </form>
  <!-- Summary Modal -->
  <div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Payment Summary</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="summaryText"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmPay" class="btn btn-success">Confirm</button>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const searchInput = document.getElementById('searchTable');
  const rows = Array.from(document.querySelectorAll('#paymentsTable tbody tr'));
  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    rows.forEach(r => {
      const text = r.innerText.toLowerCase();
      r.style.display = text.includes(term) ? '' : 'none';
    });
  });

  const modalEl = new bootstrap.Modal(document.getElementById('summaryModal'));
  document.getElementById('payBtn').addEventListener('click', () => {
    const checks = Array.from(document.querySelectorAll('input[name="lotIds"]:checked'));
    if (!checks.length) return;
    let total = 0;
    checks.forEach(c => {
      const row = c.closest('tr');
      total += parseFloat(row.children[6].innerText) || 0;
    });
    document.getElementById('summaryText').innerText = `Selected Lots: ${checks.length}\nTotal Amount: ${total.toFixed(2)}`;
    modalEl.show();
  });

  document.getElementById('confirmPay').addEventListener('click', () => {
    const ids = Array.from(document.querySelectorAll('input[name="lotIds"]:checked')).map(c => c.value);
    if (!ids.length) return;
    window.location.href = `/stitchingdashboard/payments/contract/summary?ids=${ids.join(',')}`;
  });
  </script>
  </body>
  </html>
