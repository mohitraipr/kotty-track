<!-- views/catalogUploadAdmin.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Admin Dashboard: Catalog Uploads</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bs-primary: #4e73df;
      --bs-secondary: #1cc88a;
      --bs-light: #f8f9fa;
      --bs-dark: #2e2e2e;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bs-light);
      color: var(--bs-dark);
    }
    .wrapper {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .page-header h1 {
      font-weight: 600;
      font-size: 1.75rem;
    }
    .nav-tabs .nav-link {
      font-weight: 600;
      color: var(--bs-dark);
    }
    .nav-tabs .nav-link.active {
      color: #fff;
      background: var(--bs-primary);
    }
    .card {
      border: none;
      border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    .card-header {
      background: var(--bs-light);
      border-bottom: none;
      font-weight: 600;
      font-size: 1rem;
      padding: 1rem 1.5rem;
    }
    .card-body {
      padding: 1.5rem;
    }
    /* Chart */
    #overviewCard { margin-bottom: 2rem; }
    /* Upload grid */
    .date-group { margin-bottom: 2rem; }
    .date-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: .75rem;
    }
    .mkt-card {
      border-radius: .5rem;
      overflow: hidden;
    }
    .mkt-header {
      background: var(--bs-secondary);
      color: #fff;
      padding: .5rem 1rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mkt-body {
      max-height: 200px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .5rem 1rem;
      border-bottom: 1px solid #e9ecef;
    }
    .file-item:last-child { border-bottom: none; }
    .file-name { overflow-wrap: anywhere; font-weight: 500; }
    .uploader { font-size: .85rem; color: #666; margin-right: .5rem; }
  </style>
</head>
<body>
  <div class="wrapper">

    <div class="page-header">
      <h1>
        <i class="bi bi-pie-chart-fill me-2 text-primary"></i>
        Catalog Uploads Admin
      </h1>
      <% if (error && error.length) { %>
        <div class="alert alert-danger py-1 px-3 mb-0"><%= error %></div>
      <% } %>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overviewTab">
          <i class="bi bi-pie-chart-fill me-1"></i>Overview
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#uploadsTab">
          <i class="bi bi-folder2-open me-1"></i>Uploads
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- OVERVIEW: Pie Chart by User -->
      <div class="tab-pane fade show active" id="overviewTab">
        <div class="card" id="overviewCard">
          <div class="card-header">Uploads by User</div>
          <div class="card-body">
            <canvas id="uploadsPieChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <!-- UPLOADS DETAIL -->
      <div class="tab-pane fade" id="uploadsTab">
        <% 
          // group by date
          const grouped = files.reduce((a,f)=>{
            const d = new Date(f.uploaded_at).toISOString().slice(0,10);
            (a[d]||(a[d]=[])).push(f);
            return a;
          }, {});
          const dates = Object.keys(grouped);
        %>
        <% dates.forEach(date => { 
             const dayFiles = grouped[date];
        %>
          <div class="date-group">
            <div class="date-title">
              <%= new Date(date).toLocaleDateString(undefined,{
                    year:'numeric', month:'long', day:'numeric'
                  }) %>
              <span class="badge bg-primary ms-2"><%= dayFiles.length %> files</span>
            </div>
            <div class="row g-3">
              <% 
                // group by marketplace
                const byMkt = dayFiles.reduce((a,f)=>{
                  (a[f.marketplace]||(a[f.marketplace]=[])).push(f);
                  return a;
                }, {});
                Object.entries(byMkt).forEach(([mkt, items])=> {
              %>
                <div class="col-md-6">
                  <div class="card mkt-card">
                    <div class="mkt-header">
                      <span><%= mkt %></span>
                      <span class="badge bg-light text-dark"><%= items.length %></span>
                    </div>
                    <div class="mkt-body">
                      <% items.forEach(f => { %>
                        <div class="file-item">
                          <div>
                            <span class="uploader"><%= f.username %>:</span>
                            <span class="file-name"><%= f.original_filename %></span>
                          </div>
                          <a href="/catalogUpload/download/<%= f.id %>"
                             class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download"></i>
                          </a>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        <% }) %>
      </div>

    </div>
  </div>

  <script>
    // Pie chart: uploads per user
    const rawAgg = <%- JSON.stringify(aggData) %>;
    const userCounts = rawAgg.reduce((a,r)=>{
      a[r.username] = (a[r.username]||0) + r.count;
      return a;
    }, {});
    const labels = Object.keys(userCounts);
    const data   = labels.map(u=>userCounts[u]);

    const bgColors = [
      '#4e73df', '#1cc88a', '#36b9cc',
      '#f6c23e', '#e74a3b', '#858796'
    ];

    new Chart(
      document.getElementById('uploadsPieChart'),
      {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: bgColors.slice(0, labels.length)
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, padding: 16 } }
          }
        }
      }
    );
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
