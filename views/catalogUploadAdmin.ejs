<!-- views/catalogUploadAdmin.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Admin: All Uploads</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"/>
  <style>
    body { background:#f8f9fa; }
    .wrapper { max-width:1100px; margin:2rem auto; }
    .date-card { margin-bottom:1.5rem; }
    .date-card .card-header {
      background:#e9ecef; font-weight:600;
    }
    .mkt-section { margin-top:1rem; }
    .mkt-section h5 {
      font-size:1rem; margin-bottom:.5rem;
    }
    .file-table th, .file-table td {
      vertical-align:middle;
      font-size:.9rem;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1 class="mb-4">All User Uploads</h1>
    <% if (error && error.length) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <% 
      // 1) Group by date (YYYY-MM-DD)
      const groupedByDate = files.reduce((acc, f) => {
        const d = new Date(f.uploaded_at).toISOString().slice(0,10);
        acc[d] = acc[d] || [];
        acc[d].push(f);
        return acc;
      }, {});
      const dates = Object.keys(groupedByDate);
    %>

    <% dates.forEach(date => {
         const dayFiles = groupedByDate[date];
         const totalForDay = dayFiles.length;
         // group dayFiles by marketplace
         const byMarketplace = dayFiles.reduce((acc, f) => {
           acc[f.marketplace] = acc[f.marketplace] || [];
           acc[f.marketplace].push(f);
           return acc;
         }, {});
    %>
      <div class="card date-card">
        <div class="card-header">
          <%= new Date(date).toLocaleDateString() %>
          <span class="badge bg-primary ms-2"><%= totalForDay %></span>
        </div>
        <div class="card-body">
          <% Object.entries(byMarketplace).forEach(([mktName, mktFiles]) => { %>
            <div class="mkt-section">
              <h5>
                <%= mktName %>
                <span class="badge bg-secondary ms-1"><%= mktFiles.length %></span>
              </h5>
              <table class="table table-sm table-bordered file-table">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Filename</th>
                    <th>Time</th>
                    <th>Download</th>
                  </tr>
                </thead>
                <tbody>
                  <% mktFiles.forEach(f => { %>
                    <tr>
                      <td><%= f.id %></td>
                      <td><%= f.username %></td>
                      <td><%= f.original_filename %></td>
                      <td><%= new Date(f.uploaded_at).toLocaleTimeString() %></td>
                      <td>
                        <a href="/catalogUpload/download/<%= f.id %>"
                           class="btn btn-outline-primary btn-sm">
                          <i class="bi bi-download"></i>
                        </a>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% }) %>
        </div>
      </div>
    <% }) %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // nothing dynamic here—pure server‐grouped rendering
  </script>
</body>
</html>
